# 图谱节点风险详情功能

## 📋 功能概述

实现了在图谱中点击节点直接查看相关风险的功能，包括：
1. 节点基本信息和风险分析
2. 相关预警列表（带预警单号）
3. 点击预警查看详细信息
4. 快捷操作按钮

## 🎯 核心功能

### 1. 节点详情面板

点击图谱中的任意节点，显示：

#### 基本信息
- 节点名称
- 节点类型（人员、部门、合同等）
- 风险等级（高/中/低）

#### 风险分析
根据节点类型和风险等级，智能生成风险分析：
- **高风险人员**：可能涉及利益输送、违规操作、不当关联
- **高风险预警**：触发多项风险规则，需优先处理
- **高风险合同**：招标程序不规范、合同条款异常

#### 相关预警
显示与该节点相关的预警记录：
- **预警单号**：如 YJ2025-001（可点击）
- **预警标题**：采购金额异常预警
- **风险等级**：高/中/低风险
- **预警日期**：2025-10-20
- **处理状态**：待处理/处理中/已处理

#### 关联实体
- 关联的合同、企业、部门等
- 关系类型（签订、所属、协作等）

#### 处置建议
根据风险等级提供具体建议

#### 快捷操作
- 查看完整档案
- 创建工单
- 导出报告

### 2. 预警详情模态框

点击预警单号（如 YJ2025-001），弹出详细信息：

#### 预警基本信息
- **预警单号**：YJ2025-001
- **预警标题**：采购金额异常预警
- **风险等级**：高风险
- **处理状态**：待处理
- **涉及部门**：计算机学院
- **涉及人员**：张三
- **涉及金额**：120万元
- **创建时间**：2025-10-20 14:30:25
- **更新时间**：2025-10-20 14:30:25

#### 预警描述
详细说明预警的具体情况和发现过程

#### 风险点识别
列出所有识别出的风险点：
- 采购金额超出预算30%
- 未按规定履行追加预算审批程序
- 采购需求论证不充分
- 供应商选择过程存在疑点

#### 关联信息
- **关联合同**：合同编号列表
- **关联企业**：企业名称列表

#### 处置建议
提供具体的处置建议：
1. 立即暂停合同执行
2. 启动专项审计调查
3. 约谈相关责任人
4. 完善采购管理制度

#### 处理结果（如已处理）
显示预警的处理结果和措施

#### 操作按钮
- **创建处置工单**：直接创建工单处理预警
- **导出预警报告**：导出完整的预警报告
- **关闭**：关闭模态框

## 🔍 使用流程

### 场景：追查张三的风险

#### 步骤1：在图谱中发现张三
```
1. 打开数据分析 → 图谱分析
2. 选择"部门关系图谱"或"风险传导图谱"
3. 生成图谱
4. 看到红色的"张三"节点
```

#### 步骤2：点击张三节点
```
1. 点击红色的"张三"节点
2. 页面下方显示"节点详情"面板
3. 看到：
   - 张三是高风险人员
   - 风险分析：可能涉及利益输送或收受贿赂
   - 相关预警列表（3条）
```

#### 步骤3：查看具体预警
```
1. 点击预警单号"YJ2025-001"
2. 弹出预警详情模态框
3. 看到完整信息：
   - 采购金额异常，超出预算30%
   - 金额：120万元
   - 风险点：4个具体风险点
   - 关联合同：HT2025-CS-001
   - 关联企业：某某科技有限公司
```

#### 步骤4：查看关联关系预警
```
1. 点击预警单号"YJ2025-002"
2. 看到：
   - 张三与供应商法人王五是表兄弟
   - 未按规定回避
   - 该供应商中标率异常偏高
   - 合同价格高于市场15%
```

#### 步骤5：采取行动
```
1. 点击"创建处置工单"
2. 或点击"导出预警报告"
3. 启动调查和处置流程
```

## 📊 预警数据示例

### YJ2025-001：采购金额异常预警
- **风险等级**：高风险
- **涉及金额**：120万元（超预算30%）
- **风险点**：
  - 采购金额超出预算30%
  - 未按规定履行追加预算审批程序
  - 采购需求论证不充分
  - 供应商选择过程存在疑点

### YJ2025-002：关联关系预警
- **风险等级**：中风险
- **关键发现**：张三与供应商法人王五是表兄弟
- **风险点**：
  - 采购人员与供应商存在亲属关系
  - 未按规定进行回避
  - 该供应商近期中标率异常偏高
  - 合同价格高于市场平均水平15%

### YJ2025-003：流程合规性预警
- **风险等级**：低风险
- **状态**：已处理
- **问题**：审批时限超期3天
- **处理结果**：已督促完善流程，补充材料

## 🎨 界面设计

### 节点详情面板
- 位置：图谱统计信息下方
- 显示：点击节点后自动显示
- 关闭：点击"关闭"按钮

### 预警详情模态框
- 位置：屏幕中央
- 显示：点击预警单号后弹出
- 关闭：点击"×"按钮或点击背景

### 视觉效果
- **预警单号**：蓝色字体，等宽字体
- **风险等级**：彩色徽章（红/黄/蓝）
- **处理状态**：彩色徽章（黄/蓝/绿）
- **风险点**：红色圆点标记
- **建议措施**：编号列表

## 🔧 技术实现

### 关键函数

#### showNodeRiskDetail(nodeData, graphType)
显示节点风险详情面板

#### viewAlertDetail(alertId, alertNo)
显示预警详情模态框

#### generateRelatedAlerts(nodeData)
生成相关预警列表（带单号和点击事件）

### 数据结构

```javascript
const alertDetails = {
    'YJ2025001': {
        no: 'YJ2025-001',
        title: '采购金额异常预警',
        level: 'high',
        status: '待处理',
        createTime: '2025-10-20 14:30:25',
        department: '计算机学院',
        person: '张三',
        amount: '120万元',
        description: '...',
        riskPoints: [...],
        relatedContracts: [...],
        relatedCompanies: [...],
        suggestions: [...]
    }
}
```

## 🚀 后续优化建议

### 1. 真实数据接入
```javascript
async function fetchAlertDetail(alertId) {
    const response = await fetch(`/api/alerts/${alertId}`);
    return await response.json();
}
```

### 2. 预警关联查询
```javascript
async function getRelatedAlerts(nodeId, nodeType) {
    const response = await fetch(`/api/alerts/related`, {
        method: 'POST',
        body: JSON.stringify({ nodeId, nodeType })
    });
    return await response.json();
}
```

### 3. 工单创建集成
```javascript
function createWorkOrderFromAlert(alertId) {
    // 跳转到工单创建页面，预填充预警信息
    window.location.href = `work-order.html?action=create&alertId=${alertId}`;
}
```

### 4. 报告导出
```javascript
async function exportAlertReport(alertId) {
    const response = await fetch(`/api/alerts/${alertId}/export`);
    const blob = await response.blob();
    downloadFile(blob, `预警报告_${alertId}.pdf`);
}
```

### 5. 历史记录
显示节点的历史预警记录和处理情况

### 6. 关联图谱
从预警详情中直接跳转到关联图谱

---

**实现时间**：2025-10-28  
**版本**：v1.0  
**状态**：✅ 已完成
