<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>归档页面诊断</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1f2937;
            color: #f3f4f6;
        }
        .log {
            background: #111827;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            border-left: 4px solid #3b82f6;
        }
        .success { border-left-color: #10b981; }
        .error { border-left-color: #ef4444; }
        .warning { border-left-color: #f59e0b; }
        h1 { color: #60a5fa; }
        h2 { color: #34d399; margin-top: 24px; }
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover { background: #2563eb; }
        .btn-test { background: #10b981; }
        .btn-test:hover { background: #059669; }
    </style>
</head>
<body>
    <h1>🔍 归档页面诊断工具</h1>
    
    <div>
        <button onclick="testComponents()">测试组件加载</button>
        <button onclick="testArchivePage()" class="btn-test">测试归档页面</button>
        <button onclick="clearLogs()">清除日志</button>
    </div>

    <h2>📋 诊断日志</h2>
    <div id="logs"></div>

    <script>
        function log(message, type = 'info') {
            const logs = document.getElementById('logs');
            const logDiv = document.createElement('div');
            logDiv.className = `log ${type}`;
            logDiv.innerHTML = `
                <strong>[${new Date().toLocaleTimeString()}]</strong> ${message}
            `;
            logs.insertBefore(logDiv, logs.firstChild);
        }

        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
            log('日志已清除', 'info');
        }

        function testComponents() {
            log('开始测试组件...', 'info');
            
            // 测试 common.js
            const commonScript = document.createElement('script');
            commonScript.src = 'js/common.js?v=3';
            commonScript.onload = () => {
                log('✓ common.js 加载成功', 'success');
                
                // 测试 components.js
                const componentsScript = document.createElement('script');
                componentsScript.src = 'js/components.js?v=3';
                componentsScript.onload = () => {
                    log('✓ components.js 加载成功', 'success');
                    
                    // 检查组件是否存在
                    if (typeof TopNavbar !== 'undefined') {
                        log('✓ TopNavbar 组件存在', 'success');
                    } else {
                        log('✗ TopNavbar 组件不存在', 'error');
                    }
                    
                    if (typeof SideNavbar !== 'undefined') {
                        log('✓ SideNavbar 组件存在', 'success');
                    } else {
                        log('✗ SideNavbar 组件不存在', 'error');
                    }
                    
                    if (typeof Footer !== 'undefined') {
                        log('✓ Footer 组件存在', 'success');
                    } else {
                        log('✗ Footer 组件不存在', 'error');
                    }
                };
                componentsScript.onerror = () => {
                    log('✗ components.js 加载失败', 'error');
                };
                document.head.appendChild(componentsScript);
            };
            commonScript.onerror = () => {
                log('✗ common.js 加载失败', 'error');
            };
            document.head.appendChild(commonScript);
        }

        function testArchivePage() {
            log('开始测试归档页面...', 'info');
            
            // 测试归档脚本
            const archiveScript = document.createElement('script');
            archiveScript.src = 'js/rectification-archive.js?v=1';
            archiveScript.onload = () => {
                log('✓ rectification-archive.js 加载成功', 'success');
                
                // 检查关键函数是否存在
                const functions = [
                    'loadArchivedData',
                    'initializePage',
                    'updateDashboard',
                    'renderTable',
                    'bindEvents',
                    'viewArchiveDetail'
                ];
                
                functions.forEach(funcName => {
                    if (typeof window[funcName] === 'function') {
                        log(`✓ 函数 ${funcName} 存在`, 'success');
                    } else {
                        log(`✗ 函数 ${funcName} 不存在`, 'error');
                    }
                });
                
                // 尝试调用初始化
                try {
                    if (typeof loadArchivedData === 'function') {
                        loadArchivedData();
                        log('✓ loadArchivedData() 执行成功', 'success');
                    }
                } catch (error) {
                    log(`✗ loadArchivedData() 执行失败: ${error.message}`, 'error');
                }
            };
            archiveScript.onerror = () => {
                log('✗ rectification-archive.js 加载失败', 'error');
            };
            document.head.appendChild(archiveScript);
        }

        // 页面加载时自动运行基础测试
        window.addEventListener('load', () => {
            log('诊断工具已就绪', 'success');
            log('点击按钮开始测试', 'info');
        });

        // 捕获全局错误
        window.addEventListener('error', (event) => {
            log(`全局错误: ${event.message} (${event.filename}:${event.lineno})`, 'error');
        });

        // 捕获未处理的Promise错误
        window.addEventListener('unhandledrejection', (event) => {
            log(`未处理的Promise错误: ${event.reason}`, 'error');
        });
    </script>
</body>
</html>
