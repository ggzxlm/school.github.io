<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>ETL简单测试</title>
    <style>
        body { font-family: Arial; padding: 20px; }
        button { padding: 10px 20px; margin: 5px; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 4px; }
        .success { color: green; }
        .error { color: red; }
    </style>
</head>
<body>
    <h1>ETL数据测试</h1>
    
    <div>
        <button onclick="test1()">测试1: 检查服务是否存在</button>
        <button onclick="test2()">测试2: 获取所有作业</button>
        <button onclick="test3()">测试3: 获取统计信息</button>
        <button onclick="test4()">测试4: 强制重新初始化</button>
        <button onclick="test5()">测试5: 清空并重新加载</button>
    </div>
    
    <div id="result"></div>

    <script src="js/etl-service.js"></script>
    <script>
        function showResult(title, content, isError = false) {
            const div = document.getElementById('result');
            const className = isError ? 'error' : 'success';
            div.innerHTML = `
                <h3 class="${className}">${title}</h3>
                <pre>${content}</pre>
            `;
        }

        function test1() {
            if (window.etlService) {
                showResult('✓ 测试1通过', 'window.etlService 存在');
            } else {
                showResult('✗ 测试1失败', 'window.etlService 不存在', true);
            }
        }

        function test2() {
            try {
                const jobs = window.etlService.getAll();
                showResult(
                    `✓ 测试2通过 - 找到 ${jobs.length} 个作业`,
                    JSON.stringify(jobs.map(j => ({
                        name: j.jobName,
                        status: j.status,
                        enabled: j.enabled
                    })), null, 2)
                );
            } catch (error) {
                showResult('✗ 测试2失败', error.message, true);
            }
        }

        function test3() {
            try {
                const stats = window.etlService.getStatistics();
                showResult(
                    '✓ 测试3通过',
                    JSON.stringify(stats, null, 2)
                );
            } catch (error) {
                showResult('✗ 测试3失败', error.message, true);
            }
        }

        function test4() {
            try {
                const result = window.etlService.reinitializeSampleData();
                showResult(
                    '✓ 测试4通过',
                    JSON.stringify(result, null, 2) + '\n\n重新加载后的统计:\n' + 
                    JSON.stringify(window.etlService.getStatistics(), null, 2)
                );
            } catch (error) {
                showResult('✗ 测试4失败', error.message, true);
            }
        }

        function test5() {
            try {
                // 清空
                localStorage.removeItem('etl_jobs');
                localStorage.removeItem('etl_executions');
                localStorage.removeItem('etl_versions');
                
                // 重新创建服务实例
                window.etlService = new ETLService();
                
                const stats = window.etlService.getStatistics();
                showResult(
                    '✓ 测试5通过 - 清空并重新初始化',
                    JSON.stringify(stats, null, 2)
                );
            } catch (error) {
                showResult('✗ 测试5失败', error.message, true);
            }
        }

        // 页面加载时自动运行测试1和测试2
        window.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                test1();
                setTimeout(test2, 100);
            }, 100);
        });
    </script>
</body>
</html>
