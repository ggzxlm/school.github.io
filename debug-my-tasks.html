<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>待办功能调试</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .debug-panel {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .debug-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #333;
        }
        .status-item {
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .status-ok {
            background: #d1fae5;
            color: #065f46;
        }
        .status-error {
            background: #fee2e2;
            color: #991b1b;
        }
        .status-warning {
            background: #fef3c7;
            color: #92400e;
        }
        .icon {
            font-size: 20px;
        }
        pre {
            background: #f3f4f6;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }
        button:hover {
            background: #2563eb;
        }
    </style>
</head>
<body>
    <h1>🔍 待办功能调试工具</h1>
    
    <div class="debug-panel">
        <div class="debug-title">📋 文件加载状态</div>
        <div id="fileStatus"></div>
    </div>
    
    <div class="debug-panel">
        <div class="debug-title">📊 数据结构检查</div>
        <div id="dataStatus"></div>
    </div>
    
    <div class="debug-panel">
        <div class="debug-title">🎯 功能测试</div>
        <button onclick="testFunction('showTaskDetail')">测试 showTaskDetail 函数</button>
        <button onclick="testFunction('viewSourceDetail')">测试 viewSourceDetail 函数</button>
        <button onclick="testData()">查看完整数据</button>
        <button onclick="clearCache()">清除缓存提示</button>
    </div>
    
    <div class="debug-panel">
        <div class="debug-title">📝 详细信息</div>
        <div id="detailInfo"></div>
    </div>

    <script>
        // 检查文件加载
        function checkFileStatus() {
            const status = document.getElementById('fileStatus');
            let html = '';
            
            // 检查mockTasks是否存在
            if (typeof mockTasks !== 'undefined') {
                html += '<div class="status-item status-ok"><span class="icon">✓</span> mockTasks 数据已加载</div>';
            } else {
                html += '<div class="status-item status-error"><span class="icon">✗</span> mockTasks 数据未加载</div>';
            }
            
            // 检查函数是否存在
            if (typeof showTaskDetail === 'function') {
                html += '<div class="status-item status-ok"><span class="icon">✓</span> showTaskDetail 函数已定义</div>';
            } else {
                html += '<div class="status-item status-error"><span class="icon">✗</span> showTaskDetail 函数未定义</div>';
            }
            
            if (typeof viewSourceDetail === 'function') {
                html += '<div class="status-item status-ok"><span class="icon">✓</span> viewSourceDetail 函数已定义</div>';
            } else {
                html += '<div class="status-item status-error"><span class="icon">✗</span> viewSourceDetail 函数未定义</div>';
            }
            
            // 检查Modal组件
            if (typeof Modal !== 'undefined') {
                html += '<div class="status-item status-ok"><span class="icon">✓</span> Modal 组件已加载</div>';
            } else {
                html += '<div class="status-item status-error"><span class="icon">✗</span> Modal 组件未加载</div>';
            }
            
            status.innerHTML = html;
        }
        
        // 检查数据结构
        function checkDataStatus() {
            const status = document.getElementById('dataStatus');
            let html = '';
            
            if (typeof mockTasks === 'undefined') {
                html = '<div class="status-item status-error"><span class="icon">✗</span> 无法检查数据：mockTasks 未定义</div>';
                status.innerHTML = html;
                return;
            }
            
            html += `<div class="status-item status-ok"><span class="icon">✓</span> 共有 ${mockTasks.length} 个待办任务</div>`;
            
            mockTasks.forEach((task, index) => {
                const checks = {
                    source: task.source ? '✓' : '✗',
                    details: task.details ? '✓' : '✗',
                    evidence: task.details?.evidence?.length || 0,
                    attachments: task.details?.attachments?.length || 0,
                    actions: task.process?.requiredActions?.length || 0,
                    history: task.history?.length || 0
                };
                
                const hasAllData = task.source && task.details && task.history;
                const statusClass = hasAllData ? 'status-ok' : 'status-warning';
                
                html += `
                    <div class="status-item ${statusClass}">
                        <span class="icon">${hasAllData ? '✓' : '⚠'}</span>
                        <div>
                            <strong>任务${task.id}:</strong> ${task.title}<br>
                            <small>
                                来源:${checks.source} | 
                                详情:${checks.details} | 
                                证据:${checks.evidence}项 | 
                                附件:${checks.attachments}个 | 
                                操作:${checks.actions}项 | 
                                记录:${checks.history}条
                            </small>
                        </div>
                    </div>
                `;
            });
            
            status.innerHTML = html;
        }
        
        // 测试函数
        function testFunction(funcName) {
            const detail = document.getElementById('detailInfo');
            
            if (funcName === 'showTaskDetail') {
                if (typeof showTaskDetail === 'function' && typeof mockTasks !== 'undefined') {
                    detail.innerHTML = '<div class="status-item status-ok">正在调用 showTaskDetail(1)...</div>';
                    try {
                        showTaskDetail(1);
                        detail.innerHTML += '<div class="status-item status-ok">函数调用成功！请检查是否弹出模态框。</div>';
                    } catch (e) {
                        detail.innerHTML += `<div class="status-item status-error">函数调用失败：${e.message}</div>`;
                    }
                } else {
                    detail.innerHTML = '<div class="status-item status-error">函数或数据未加载</div>';
                }
            } else if (funcName === 'viewSourceDetail') {
                if (typeof viewSourceDetail === 'function') {
                    detail.innerHTML = '<div class="status-item status-ok">正在调用 viewSourceDetail("alert", "ALERT2025001")...</div>';
                    try {
                        viewSourceDetail('alert', 'ALERT2025001');
                        detail.innerHTML += '<div class="status-item status-ok">函数调用成功！</div>';
                    } catch (e) {
                        detail.innerHTML += `<div class="status-item status-error">函数调用失败：${e.message}</div>`;
                    }
                } else {
                    detail.innerHTML = '<div class="status-item status-error">函数未加载</div>';
                }
            }
        }
        
        // 查看数据
        function testData() {
            const detail = document.getElementById('detailInfo');
            if (typeof mockTasks !== 'undefined' && mockTasks.length > 0) {
                detail.innerHTML = `
                    <h4>第一个任务的完整数据：</h4>
                    <pre>${JSON.stringify(mockTasks[0], null, 2)}</pre>
                `;
            } else {
                detail.innerHTML = '<div class="status-item status-error">数据未加载</div>';
            }
        }
        
        // 清除缓存提示
        function clearCache() {
            const detail = document.getElementById('detailInfo');
            detail.innerHTML = `
                <div class="status-item status-warning">
                    <span class="icon">⚠</span>
                    <div>
                        <strong>如果功能不正常，请尝试以下方法：</strong><br><br>
                        <strong>1. 强制刷新（推荐）</strong><br>
                        Windows/Linux: Ctrl + Shift + R 或 Ctrl + F5<br>
                        Mac: Cmd + Shift + R<br><br>
                        <strong>2. 清除浏览器缓存</strong><br>
                        Chrome: Ctrl + Shift + Delete<br>
                        选择"缓存的图片和文件"并清除<br><br>
                        <strong>3. 使用无痕模式</strong><br>
                        Chrome: Ctrl + Shift + N<br>
                        Firefox: Ctrl + Shift + P<br><br>
                        <strong>4. 禁用缓存（开发者模式）</strong><br>
                        按F12打开开发者工具<br>
                        在Network标签中勾选"Disable cache"
                    </div>
                </div>
            `;
        }
        
        // 页面加载时执行检查
        window.addEventListener('DOMContentLoaded', () => {
            // 延迟检查，确保所有脚本都已加载
            setTimeout(() => {
                checkFileStatus();
                checkDataStatus();
            }, 100);
        });
    </script>
    
    <!-- 加载必要的文件 -->
    <script src="js/components.js"></script>
    <script src="js/my-tasks.js?v=2.0&t=<?php echo time(); ?>"></script>
</body>
</html>
