# 预警转化线索功能说明

## 📅 更新时间
2025-10-28

## 🎯 功能概述
当用户在新增线索时选择"预警转化"作为来源时，系统会弹出预警列表供用户选择，选择后自动填充相关信息到线索表单。

## ✨ 功能特性

### 1. 预警选择模态框
- **搜索功能**：支持按预警编号、标题、部门、人员搜索
- **预警列表**：显示所有可选择的预警（当前有6个模拟数据）
- **确认按钮**：选择预警后启用，确认后自动填充表单

### 2. 预警数据
系统包含6个模拟预警数据：

| 预警编号 | 标题 | 类型 | 风险等级 | 部门 |
|---------|------|------|---------|------|
| YJ-2025-001 | 科研经费异常报销 - 连号发票检测 | 科研经费 | 高风险 | 计算机学院 |
| YJ-2025-002 | 三公经费超预算预警 | 财务管理 | 高风险 | 行政办公室 |
| YJ-2025-003 | 招生录取低分高录异常 | 招生录取 | 高风险 | 计算机学院 |
| YJ-2025-004 | 基建项目资金使用异常 | 基建工程 | 中风险 | 基建处 |
| YJ-2025-005 | 采购项目供应商关联异常 | 采购管理 | 中风险 | 采购中心 |
| YJ-2025-006 | 学术不端行为预警 | 学术诚信 | 高风险 | 数学学院 |

### 3. 交互流程

#### 步骤1：选择预警转化
1. 用户点击"新增线索"按钮
2. 在"线索来源"下拉框中选择"预警转化"
3. 系统自动弹出预警选择模态框

#### 步骤2：搜索和选择预警
1. 用户可以在搜索框输入关键词过滤预警
2. 点击预警项进行选择
3. 选中的预警项会高亮显示（蓝色边框和背景）
4. "确认选择"按钮变为可用状态

#### 步骤3：确认选择
1. 点击"确认选择"按钮
2. 系统自动填充线索表单：
   - **线索标题** = 预警标题
   - **线索类型** = 预警类型
   - **风险等级** = 预警风险等级
   - **涉及部门** = 预警部门
   - **涉及人员** = 预警人员
   - **线索描述** = 基于预警转化的描述
3. 关闭预警选择模态框

#### 步骤4：提交线索
1. 用户可以修改自动填充的信息
2. 补充其他必填信息
3. 点击"提交"创建线索
4. 线索中会保存预警来源信息

### 4. 自动填充逻辑

```javascript
// 确认预警选择时自动填充表单
document.getElementById('clueTitle').value = selectedAlert.title;
document.getElementById('clueType').value = selectedAlert.type;
document.getElementById('clueRisk').value = selectedAlert.risk;
document.getElementById('clueDepartment').value = selectedAlert.department;
document.getElementById('cluePerson').value = selectedAlert.person;
document.getElementById('clueDescription').value = 
    `基于预警"${selectedAlert.title}"转化而来。\n\n原预警描述：${selectedAlert.description}`;
```

### 5. 预警来源关联

提交线索时，如果选择了预警，会自动添加 `alertSource` 字段：

```javascript
if (selectedAlert) {
    newClue.alertSource = {
        alertId: selectedAlert.id,              // 预警编号
        alertTitle: selectedAlert.title,        // 预警标题
        alertType: selectedAlert.type,          // 预警类型
        alertRisk: '高风险/中风险/低风险',      // 风险等级
        alertTime: selectedAlert.time,          // 预警时间
        alertDepartment: selectedAlert.department // 预警部门
    };
}
```

## 🎨 界面设计

### 预警列表项
每个预警项显示以下信息：
- **标题**：预警标题（加粗显示）
- **徽章**：风险等级徽章 + 预警类型徽章
- **元数据**：编号、部门、人员、时间
- **描述**：预警详细描述

### 交互状态
- **默认状态**：灰色边框（#e5e7eb）
- **悬停状态**：蓝色边框 + 轻微阴影
- **选中状态**：蓝色边框 + 蓝色背景（5%透明度）

### 响应式设计
- **桌面端**：预警信息横向排列，宽度900px
- **移动端**：预警信息纵向排列，宽度90%

## 📁 文件更新

### 1. clue-library.html (v7)
- 添加预警选择模态框
- 为线索来源选择框添加 `onchange="onSourceChange()"` 事件

### 2. js/clue-library.js (v6)
- 添加 `mockAlerts` 预警数据数组（6个预警）
- 添加 `selectedAlert` 全局变量
- 添加 `onSourceChange()` 函数：监听来源选择变化
- 添加 `showAlertSelectModal()` 函数：显示预警选择模态框
- 添加 `closeAlertSelectModal()` 函数：关闭预警选择模态框
- 添加 `renderAlertList()` 函数：渲染预警列表
- 添加 `filterAlerts()` 函数：过滤预警
- 添加 `selectAlert()` 函数：选择预警
- 添加 `confirmAlertSelection()` 函数：确认预警选择
- 更新 `submitNewClue()` 函数：保存预警来源信息

### 3. css/clue-library.css (v7)
- 添加预警选择列表样式
- 添加预警项样式（默认、悬停、选中状态）
- 添加徽章样式（高风险、中风险、低风险、类型）
- 添加响应式样式

## 🧪 测试步骤

1. **强制刷新浏览器**
   - Windows/Linux: `Ctrl + Shift + R`
   - Mac: `Cmd + Shift + R`

2. **打开测试页面**
   - 访问 `test-alert-selection.html`
   - 或直接访问 `clue-library.html`

3. **测试功能**
   - 点击"新增线索"按钮
   - 选择"预警转化"作为来源
   - 验证预警选择模态框弹出
   - 测试搜索功能
   - 选择预警并确认
   - 验证表单自动填充
   - 提交线索

4. **验证结果**
   - 检查线索是否创建成功
   - 查看线索详情中的预警来源信息

## 🔄 业务流程

```
预警 → 线索 → 工单 → 整改
 ↓      ↓      ↓      ↓
选择   创建   处理   执行
```

### 数据追溯
创建的线索包含完整的预警来源信息，支持：
- 在线索详情中查看来源预警
- 从线索跳转到预警详情
- 追溯完整的处理链路

## ⚠️ 注意事项

1. **必须选择预警**：选择"预警转化"后必须选择具体预警
2. **可以取消**：如果取消选择，来源会重置为空
3. **可以修改**：自动填充的信息用户可以修改
4. **保存关联**：预警来源信息会保存到线索中
5. **支持跳转**：支持从线索详情跳转到预警详情

## 🚀 后续优化建议

1. **预警状态过滤**：只显示待处理的预警
2. **批量选择**：支持预警的批量选择
3. **详情预览**：添加预警详情预览功能
4. **直接创建**：支持从预警详情直接创建线索
5. **审批流程**：添加预警转化的审批流程
6. **双向关联**：实现预警和线索的双向关联
7. **转化统计**：添加转化记录和统计分析

## 🐛 常见问题

**Q: 选择预警转化后没有弹出选择框？**
A: 检查浏览器控制台是否有错误，确保已强制刷新浏览器。

**Q: 搜索功能不工作？**
A: 确保输入的关键词与预警信息匹配（编号、标题、部门、人员）。

**Q: 自动填充的信息可以修改吗？**
A: 可以，用户可以修改任何自动填充的信息。

**Q: 如何查看预警的详细信息？**
A: 创建线索后，在线索详情中可以查看预警来源信息。

**Q: 取消选择会怎样？**
A: 如果点击"取消"或关闭模态框且未选择预警，线索来源会重置为空。

## 📊 技术实现

### 核心技术
- **原生JavaScript**：无依赖框架
- **事件驱动**：基于事件监听实现交互
- **模态框**：使用CSS类控制显示/隐藏
- **动态渲染**：使用模板字符串动态生成HTML

### 性能优化
- **事件委托**：使用事件委托处理列表项点击
- **实时搜索**：使用input事件实现实时过滤
- **状态管理**：使用全局变量管理选中状态

### 代码质量
- ✅ 通过语法检查（无诊断错误）
- ✅ 代码格式规范
- ✅ 注释清晰完整
- ✅ 函数职责单一

## 📝 更新日志

### v7 (2025-10-28)
- ✨ 新增预警选择模态框
- ✨ 新增预警数据（6个模拟数据）
- ✨ 新增搜索过滤功能
- ✨ 新增自动填充功能
- ✨ 新增预警来源关联
- 🎨 新增预警列表样式
- 📝 新增功能文档和测试页面

---

**开发者**: Kiro AI Assistant  
**更新时间**: 2025-10-28  
**版本**: v7
