<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½å…³è”åˆ†æ - é«˜æ ¡çºªæ£€å®¡è®¡ç›‘ç®¡ä¸€ä½“åŒ–å¹³å°</title>
    <link rel="stylesheet" href="css/common.css">
    <link rel="stylesheet" href="css/relation-analysis.css">
    <script src="https://gw.alipayobjects.com/os/lib/antv/g6/4.8.12/dist/g6.min.js"></script>
</head>
<body>
    <div class="container">
        <!-- é¡¶éƒ¨å¯¼èˆª -->
        <header class="header">
            <div class="header-left">
                <h1>æ™ºèƒ½å…³è”åˆ†æ</h1>
            </div>
            <div class="header-right">
                <button class="btn btn-secondary" onclick="window.location.href='index.html'">è¿”å›é¦–é¡µ</button>
            </div>
        </header>

        <!-- ä¸»å†…å®¹åŒº -->
        <div class="main-content">
            <!-- å·¦ä¾§æ§åˆ¶é¢æ¿ -->
            <aside class="control-panel">
                <div class="panel-section">
                    <h3>å›¾è°±æ„å»º</h3>
                    <div class="form-group">
                        <label>é€‰æ‹©å®ä½“</label>
                        <select id="entitySelect" multiple>
                            <option value="P001">å¼ ä¸‰(é‡‡è´­ç»ç†)</option>
                            <option value="P002">æå››(è´¢åŠ¡æ€»ç›‘)</option>
                            <option value="P003">ç‹äº”</option>
                            <option value="C001">æŸæŸç§‘æŠ€æœ‰é™å…¬å¸</option>
                            <option value="C002">æŸæŸå»ºç­‘å·¥ç¨‹å…¬å¸</option>
                            <option value="CT001">åŠå…¬è®¾å¤‡é‡‡è´­åˆåŒ</option>
                            <option value="CT002">å®éªŒå®¤å»ºè®¾åˆåŒ</option>
                            <option value="B001">åŠå…¬è®¾å¤‡é‡‡è´­é¡¹ç›®</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>å…³è”æ·±åº¦</label>
                        <select id="depthSelect">
                            <option value="1">1å±‚</option>
                            <option value="2" selected>2å±‚</option>
                            <option value="3">3å±‚</option>
                            <option value="4">4å±‚</option>
                            <option value="5">5å±‚</option>
                        </select>
                    </div>
                    <button class="btn btn-primary btn-block" onclick="buildGraph()">æ„å»ºå›¾è°±</button>
                </div>

                <div class="panel-section">
                    <h3>è¿‡æ»¤æ¡ä»¶</h3>
                    <div class="form-group">
                        <label>å®ä½“ç±»å‹</label>
                        <div class="checkbox-group">
                            <label><input type="checkbox" value="PERSON" checked> äººå‘˜</label>
                            <label><input type="checkbox" value="COMPANY" checked> ä¼ä¸š</label>
                            <label><input type="checkbox" value="CONTRACT" checked> åˆåŒ</label>
                            <label><input type="checkbox" value="BID" checked> æŠ•æ ‡</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>å…³ç³»ç±»å‹</label>
                        <div class="checkbox-group">
                            <label><input type="checkbox" value="FAMILY" checked> äº²å±</label>
                            <label><input type="checkbox" value="EQUITY" checked> è‚¡æƒ</label>
                            <label><input type="checkbox" value="EMPLOYMENT" checked> ä»»èŒ</label>
                            <label><input type="checkbox" value="APPROVAL" checked> å®¡æ‰¹</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>é£é™©ç­‰çº§</label>
                        <div class="checkbox-group">
                            <label><input type="checkbox" value="HIGH" checked> é«˜é£é™©</label>
                            <label><input type="checkbox" value="MEDIUM" checked> ä¸­é£é™©</label>
                            <label><input type="checkbox" value="LOW" checked> ä½é£é™©</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label><input type="checkbox" id="includeHidden" checked> æ˜¾ç¤ºéšè—å…³è”</label>
                    </div>
                    <button class="btn btn-secondary btn-block" onclick="applyFilters()">åº”ç”¨è¿‡æ»¤</button>
                </div>

                <div class="panel-section">
                    <h3>åˆ†æåŠŸèƒ½</h3>
                    <button class="btn btn-secondary btn-block" onclick="identifyHiddenRelations()">è¯†åˆ«éšè—å…³è”</button>
                    <button class="btn btn-secondary btn-block" onclick="analyzeRiskPaths()">åˆ†æé£é™©è·¯å¾„</button>
                    <button class="btn btn-secondary btn-block" onclick="identifyKeyNodes()">è¯†åˆ«å…³é”®èŠ‚ç‚¹</button>
                    <button class="btn btn-secondary btn-block" onclick="generateReport()">ç”Ÿæˆåˆ†ææŠ¥å‘Š</button>
                </div>

                <div class="panel-section">
                    <h3>å¸ƒå±€è®¾ç½®</h3>
                    <select id="layoutSelect" onchange="changeLayout()">
                        <option value="force" selected>åŠ›å¯¼å‘å¸ƒå±€</option>
                        <option value="circular">ç¯å½¢å¸ƒå±€</option>
                        <option value="radial">è¾å°„å¸ƒå±€</option>
                        <option value="dagre">å±‚æ¬¡å¸ƒå±€</option>
                        <option value="concentric">åŒå¿ƒåœ†å¸ƒå±€</option>
                    </select>
                </div>

                <div class="panel-section">
                    <h3>æ“ä½œ</h3>
                    <button class="btn btn-secondary btn-block" onclick="fitView()">é€‚åº”ç”»å¸ƒ</button>
                    <button class="btn btn-secondary btn-block" onclick="exportImage()">å¯¼å‡ºå›¾ç‰‡</button>
                    <button class="btn btn-secondary btn-block" onclick="clearGraph()">æ¸…ç©ºå›¾è°±</button>
                </div>
            </aside>

            <!-- ä¸­é—´å›¾è°±å±•ç¤ºåŒº -->
            <div class="graph-container">
                <div class="graph-toolbar">
                    <div class="toolbar-left">
                        <span id="graphStats">èŠ‚ç‚¹: 0 | è¾¹: 0</span>
                    </div>
                    <div class="toolbar-right">
                        <button class="btn-icon" onclick="zoomIn()" title="æ”¾å¤§">+</button>
                        <button class="btn-icon" onclick="zoomOut()" title="ç¼©å°">-</button>
                        <button class="btn-icon" onclick="fitView()" title="é€‚åº”ç”»å¸ƒ">âŠ¡</button>
                    </div>
                </div>
                <div id="graphCanvas"></div>
                <div id="loadingOverlay" class="loading-overlay" style="display: none;">
                    <div class="spinner"></div>
                    <p>æ­£åœ¨åˆ†æ...</p>
                </div>
            </div>

            <!-- å³ä¾§è¯¦æƒ…é¢æ¿ -->
            <aside class="detail-panel">
                <div class="panel-tabs">
                    <button class="tab-btn active" onclick="switchTab('node')">èŠ‚ç‚¹è¯¦æƒ…</button>
                    <button class="tab-btn" onclick="switchTab('relation')">å…³ç³»è¯¦æƒ…</button>
                    <button class="tab-btn" onclick="switchTab('analysis')">åˆ†æç»“æœ</button>
                </div>

                <div id="nodeDetail" class="tab-content active">
                    <div class="empty-state">
                        <p>ç‚¹å‡»èŠ‚ç‚¹æŸ¥çœ‹è¯¦æƒ…</p>
                    </div>
                </div>

                <div id="relationDetail" class="tab-content">
                    <div class="empty-state">
                        <p>ç‚¹å‡»è¾¹æŸ¥çœ‹å…³ç³»è¯¦æƒ…</p>
                    </div>
                </div>

                <div id="analysisDetail" class="tab-content">
                    <div class="empty-state">
                        <p>æ‰§è¡Œåˆ†æåæŸ¥çœ‹ç»“æœ</p>
                    </div>
                </div>
            </aside>
        </div>
    </div>

    <script src="js/common.js"></script>
    <script src="js/relation-graph-service.js"></script>
    <script src="js/hidden-relation-service.js"></script>
    <script src="js/relation-graph-visualization.js"></script>
    <script src="js/risk-path-analysis-service.js"></script>
    <script src="js/relation-filter-service.js"></script>
    <script>
        let visualization = null;
        let currentGraph = null;

        // åˆå§‹åŒ–
        async function init() {
            try {
                // åˆå§‹åŒ–æœåŠ¡
                await window.relationGraphService.initialize();
                await window.hiddenRelationService.initialize();
                await window.riskPathAnalysisService.initialize();
                await window.relationFilterService.initialize();

                // åˆå§‹åŒ–å¯è§†åŒ–
                visualization = new RelationGraphVisualization('graphCanvas');
                await visualization.initialize();

                // ç»‘å®šäº‹ä»¶
                visualization.onNodeClick = showNodeDetail;
                visualization.onEdgeClick = showRelationDetail;

                console.log('æ™ºèƒ½å…³è”åˆ†ææ¨¡å—åˆå§‹åŒ–å®Œæˆ');
            } catch (error) {
                console.error('åˆå§‹åŒ–å¤±è´¥:', error);
                alert('åˆå§‹åŒ–å¤±è´¥: ' + error.message);
            }
        }

        // æ„å»ºå›¾è°±
        async function buildGraph() {
            const entitySelect = document.getElementById('entitySelect');
            const depthSelect = document.getElementById('depthSelect');
            
            const selectedEntities = Array.from(entitySelect.selectedOptions).map(opt => opt.value);
            const depth = parseInt(depthSelect.value);

            if (selectedEntities.length === 0) {
                alert('è¯·é€‰æ‹©è‡³å°‘ä¸€ä¸ªå®ä½“');
                return;
            }

            showLoading(true);

            try {
                currentGraph = await window.relationGraphService.buildGraph({
                    entityIds: selectedEntities,
                    depth: depth
                });

                visualization.render(currentGraph);
                updateGraphStats(currentGraph);
                
                // è‡ªåŠ¨æ˜¾ç¤ºå›¾è°±åˆ†æç»“æœå¹¶åˆ‡æ¢åˆ°åˆ†æç»“æœæ ‡ç­¾é¡µ
                console.log('å‡†å¤‡æ›´æ–°å›¾è°±åˆ†æç»“æœ...');
                updateGraphAnalysis(currentGraph);
                console.log('å‡†å¤‡åˆ‡æ¢åˆ°åˆ†æç»“æœæ ‡ç­¾é¡µ...');
                switchTab('analysis');
                console.log('å·²åˆ‡æ¢åˆ°åˆ†æç»“æœæ ‡ç­¾é¡µ');
            } catch (error) {
                console.error('æ„å»ºå›¾è°±å¤±è´¥:', error);
                alert('æ„å»ºå›¾è°±å¤±è´¥: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        // åº”ç”¨è¿‡æ»¤
        function applyFilters() {
            if (!currentGraph) {
                alert('è¯·å…ˆæ„å»ºå›¾è°±');
                return;
            }

            const entityTypes = getCheckedValues('input[type="checkbox"][value="PERSON"], input[type="checkbox"][value="COMPANY"], input[type="checkbox"][value="CONTRACT"], input[type="checkbox"][value="BID"]');
            const relationTypes = getCheckedValues('input[type="checkbox"][value="FAMILY"], input[type="checkbox"][value="EQUITY"], input[type="checkbox"][value="EMPLOYMENT"], input[type="checkbox"][value="APPROVAL"]');
            const riskLevels = getCheckedValues('input[type="checkbox"][value="HIGH"], input[type="checkbox"][value="MEDIUM"], input[type="checkbox"][value="LOW"]');
            const includeHidden = document.getElementById('includeHidden').checked;

            visualization.setFilters({
                entityTypes,
                relationTypes,
                riskLevels,
                includeHidden
            });
        }

        // è¯†åˆ«éšè—å…³è”
        async function identifyHiddenRelations() {
            if (!currentGraph) {
                alert('è¯·å…ˆæ„å»ºå›¾è°±');
                return;
            }

            showLoading(true);

            try {
                const hiddenRelations = await window.hiddenRelationService.identifyHiddenRelations(currentGraph);
                
                // å°†éšè—å…³è”æ·»åŠ åˆ°å›¾è°±
                currentGraph.edges.push(...hiddenRelations.map(r => ({
                    id: r.id,
                    source: r.sourceId,
                    target: r.targetId,
                    type: r.type,
                    label: r.label,
                    riskLevel: r.riskLevel,
                    confidence: r.confidence,
                    isHidden: true
                })));

                visualization.render(currentGraph);
                updateGraphStats(currentGraph);

                // æ˜¾ç¤ºç»“æœ
                showAnalysisResult('éšè—å…³è”è¯†åˆ«', {
                    total: hiddenRelations.length,
                    high: hiddenRelations.filter(r => r.riskLevel === 'HIGH').length,
                    medium: hiddenRelations.filter(r => r.riskLevel === 'MEDIUM').length,
                    relations: hiddenRelations
                });

                alert(`è¯†åˆ«å®Œæˆ,å‘ç° ${hiddenRelations.length} ä¸ªéšè—å…³è”`);
            } catch (error) {
                console.error('è¯†åˆ«éšè—å…³è”å¤±è´¥:', error);
                alert('è¯†åˆ«å¤±è´¥: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        // åˆ†æé£é™©è·¯å¾„
        async function analyzeRiskPaths() {
            if (!currentGraph) {
                alert('è¯·å…ˆæ„å»ºå›¾è°±');
                return;
            }

            showLoading(true);

            try {
                const entitySelect = document.getElementById('entitySelect');
                const selectedEntities = Array.from(entitySelect.selectedOptions).map(opt => opt.value);
                const startNodeId = selectedEntities[0];

                const riskPaths = await window.riskPathAnalysisService.analyzeRiskPaths(currentGraph, startNodeId);
                
                // æ ‡è¯†é£é™©è·¯å¾„
                const markedGraph = window.riskPathAnalysisService.markRiskPathsInGraph(currentGraph, riskPaths);
                visualization.render(markedGraph);

                // æ˜¾ç¤ºç»“æœ
                showAnalysisResult('é£é™©è·¯å¾„åˆ†æ', {
                    total: riskPaths.length,
                    high: riskPaths.filter(p => p.riskLevel === 'HIGH').length,
                    medium: riskPaths.filter(p => p.riskLevel === 'MEDIUM').length,
                    paths: riskPaths.slice(0, 10)
                });

                alert(`åˆ†æå®Œæˆ,å‘ç° ${riskPaths.length} æ¡é£é™©è·¯å¾„`);
            } catch (error) {
                console.error('åˆ†æé£é™©è·¯å¾„å¤±è´¥:', error);
                alert('åˆ†æå¤±è´¥: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        // è¯†åˆ«å…³é”®èŠ‚ç‚¹
        function identifyKeyNodes() {
            if (!currentGraph) {
                alert('è¯·å…ˆæ„å»ºå›¾è°±');
                return;
            }

            showLoading(true);

            try {
                const keyNodes = window.relationFilterService.identifyKeyNodes(currentGraph);
                
                // é«˜äº®å…³é”®èŠ‚ç‚¹
                keyNodes.forEach(node => {
                    visualization.highlightNode(node.id);
                });

                // æ˜¾ç¤ºç»“æœ
                showAnalysisResult('å…³é”®èŠ‚ç‚¹è¯†åˆ«', {
                    total: keyNodes.length,
                    nodes: keyNodes
                });

                alert(`è¯†åˆ«å®Œæˆ,å‘ç° ${keyNodes.length} ä¸ªå…³é”®èŠ‚ç‚¹`);
            } catch (error) {
                console.error('è¯†åˆ«å…³é”®èŠ‚ç‚¹å¤±è´¥:', error);
                alert('è¯†åˆ«å¤±è´¥: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        // ç”Ÿæˆåˆ†ææŠ¥å‘Š
        async function generateReport() {
            if (!currentGraph) {
                alert('è¯·å…ˆæ„å»ºå›¾è°±');
                return;
            }

            showLoading(true);

            try {
                // æ‰§è¡Œå®Œæ•´åˆ†æ
                const hiddenRelations = await window.hiddenRelationService.identifyHiddenRelations(currentGraph);
                const entitySelect = document.getElementById('entitySelect');
                const selectedEntities = Array.from(entitySelect.selectedOptions).map(opt => opt.value);
                const riskPaths = await window.riskPathAnalysisService.analyzeRiskPaths(currentGraph, selectedEntities[0]);
                
                const report = window.riskPathAnalysisService.generateAnalysisReport(currentGraph, riskPaths, hiddenRelations);
                
                // æ˜¾ç¤ºæŠ¥å‘Š
                showAnalysisResult('ç»¼åˆåˆ†ææŠ¥å‘Š', report);
                switchTab('analysis');

                alert('æŠ¥å‘Šç”Ÿæˆå®Œæˆ');
            } catch (error) {
                console.error('ç”ŸæˆæŠ¥å‘Šå¤±è´¥:', error);
                alert('ç”ŸæˆæŠ¥å‘Šå¤±è´¥: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        // åˆ‡æ¢å¸ƒå±€
        function changeLayout() {
            const layoutSelect = document.getElementById('layoutSelect');
            const layout = layoutSelect.value;
            visualization.changeLayout(layout);
        }

        // é€‚åº”ç”»å¸ƒ
        function fitView() {
            visualization.fitView();
        }

        // æ”¾å¤§
        function zoomIn() {
            visualization.zoom(1.2);
        }

        // ç¼©å°
        function zoomOut() {
            visualization.zoom(0.8);
        }

        // å¯¼å‡ºå›¾ç‰‡
        function exportImage() {
            visualization.exportImage('relation-graph');
        }

        // æ¸…ç©ºå›¾è°±
        function clearGraph() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºå›¾è°±å—?')) {
                currentGraph = null;
                visualization.render({ nodes: [], edges: [] });
                updateGraphStats({ nodes: [], edges: [] });
                document.getElementById('nodeDetail').innerHTML = '<div class="empty-state"><p>ç‚¹å‡»èŠ‚ç‚¹æŸ¥çœ‹è¯¦æƒ…</p></div>';
                document.getElementById('relationDetail').innerHTML = '<div class="empty-state"><p>ç‚¹å‡»è¾¹æŸ¥çœ‹å…³ç³»è¯¦æƒ…</p></div>';
                document.getElementById('analysisDetail').innerHTML = '<div class="empty-state"><p>æ‰§è¡Œåˆ†æåæŸ¥çœ‹ç»“æœ</p></div>';
            }
        }

        // æ˜¾ç¤ºèŠ‚ç‚¹è¯¦æƒ…
        function showNodeDetail(node) {
            console.log('æ˜¾ç¤ºèŠ‚ç‚¹è¯¦æƒ…:', node);
            
            const typeNames = {
                'PERSON': 'äººå‘˜',
                'COMPANY': 'ä¼ä¸š',
                'CONTRACT': 'åˆåŒ',
                'BID': 'æ‹›æ ‡é¡¹ç›®'
            };
            
            const riskNames = {
                'HIGH': 'é«˜é£é™©',
                'MEDIUM': 'ä¸­é£é™©',
                'LOW': 'ä½é£é™©',
                'NORMAL': 'æ­£å¸¸'
            };
            
            const nodeName = node.label || node.name || node.id;
            const nodeType = typeNames[node.type] || node.type;
            const riskLevel = node.riskLevel || 'NORMAL';
            const riskName = riskNames[riskLevel] || riskLevel;
            
            let html = `
                <div class="detail-content">
                    <div style="border-bottom: 2px solid #e5e7eb; padding-bottom: 12px; margin-bottom: 16px;">
                        <h4 style="font-size: 18px; font-weight: 600; color: #1f2937; margin-bottom: 8px;">${nodeName}</h4>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <span style="padding: 4px 12px; background: #f3f4f6; border-radius: 4px; font-size: 12px;">${nodeType}</span>
                            <span class="risk-badge risk-${riskLevel.toLowerCase()}">${riskName}</span>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 16px;">
                        <h5 style="font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 8px;">åŸºæœ¬ä¿¡æ¯</h5>
            `;
            
            // æ ¹æ®èŠ‚ç‚¹ç±»å‹æ˜¾ç¤ºä¸åŒçš„å±æ€§
            if (node.type === 'PERSON') {
                if (node.idCard) html += `<div class="detail-item"><label>èº«ä»½è¯å·:</label><span>${node.idCard}</span></div>`;
                if (node.department) html += `<div class="detail-item"><label>æ‰€å±éƒ¨é—¨:</label><span>${node.department}</span></div>`;
                if (node.position) html += `<div class="detail-item"><label>èŒä½:</label><span>${node.position}</span></div>`;
                
                // æ·»åŠ å…³è”ç»Ÿè®¡
                html += `</div><div style="margin-bottom: 16px;">
                    <h5 style="font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 8px;">å…³è”ç»Ÿè®¡</h5>
                    <div class="detail-item"><label>å…³è”ä¼ä¸š:</label><span>2 å®¶</span></div>
                    <div class="detail-item"><label>å…³è”åˆåŒ:</label><span>3 ä¸ª</span></div>
                    <div class="detail-item"><label>å…³è”é¡¹ç›®:</label><span>1 ä¸ª</span></div>
                </div>`;
                
                // æ·»åŠ é£é™©æç¤º
                if (riskLevel === 'HIGH') {
                    html += `<div style="background: #fef2f2; border-left: 3px solid #ef4444; padding: 12px; border-radius: 4px;">
                        <h5 style="font-size: 14px; font-weight: 600; color: #dc2626; margin-bottom: 8px;">âš ï¸ é£é™©æç¤º</h5>
                        <ul style="margin: 0; padding-left: 20px; color: #991b1b; font-size: 13px;">
                            <li>ä¸ä¾›åº”å•†å­˜åœ¨äº²å±å…³ç³»</li>
                            <li>å‚ä¸å¤šä¸ªé«˜é£é™©é‡‡è´­é¡¹ç›®</li>
                            <li>å®¡æ‰¹æµç¨‹å­˜åœ¨å¼‚å¸¸</li>
                        </ul>
                    </div>`;
                }
                
            } else if (node.type === 'COMPANY') {
                if (node.properties.creditCode) html += `<div class="detail-item"><label>ç»Ÿä¸€ç¤¾ä¼šä¿¡ç”¨ä»£ç :</label><span>${node.properties.creditCode}</span></div>`;
                if (node.properties.legalRep) html += `<div class="detail-item"><label>æ³•å®šä»£è¡¨äºº:</label><span>${node.properties.legalRep}</span></div>`;
                if (node.properties.registeredCapital) html += `<div class="detail-item"><label>æ³¨å†Œèµ„æœ¬:</label><span>${node.properties.registeredCapital}</span></div>`;
                if (node.properties.establishDate) html += `<div class="detail-item"><label>æˆç«‹æ—¥æœŸ:</label><span>${node.properties.establishDate}</span></div>`;
                
                // æ ¹æ®å…¬å¸åç§°æ˜¾ç¤ºä¸åŒçš„ä¸šåŠ¡ç»Ÿè®¡
                const isC001 = node.id === 'C001' || node.label.includes('ç§‘æŠ€');
                const isC002 = node.id === 'C002' || node.label.includes('å»ºç­‘');
                
                html += `</div><div style="margin-bottom: 16px;">
                    <h5 style="font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 8px;">ä¸šåŠ¡ç»Ÿè®¡</h5>
                    <div class="detail-item"><label>ä¸­æ ‡é¡¹ç›®:</label><span>${isC001 ? '5' : '3'} ä¸ª</span></div>
                    <div class="detail-item"><label>åˆåŒæ€»é¢:</label><span>${isC001 ? '850ä¸‡å…ƒ' : '2500ä¸‡å…ƒ'}</span></div>
                    <div class="detail-item"><label>å±¥çº¦è¯„åˆ†:</label><span style="color: ${isC001 ? '#f59e0b' : '#52c41a'};">${isC001 ? '75åˆ†' : '88åˆ†'}</span></div>
                </div>`;
                
                if (riskLevel === 'HIGH' && isC001) {
                    html += `<div style="background: #fef2f2; border-left: 3px solid #ef4444; padding: 12px; border-radius: 4px;">
                        <h5 style="font-size: 14px; font-weight: 600; color: #dc2626; margin-bottom: 8px;">âš ï¸ é£é™©æç¤º</h5>
                        <ul style="margin: 0; padding-left: 20px; color: #991b1b; font-size: 13px; line-height: 1.8;">
                            <li>æ³•å®šä»£è¡¨äººç‹äº”ä¸é‡‡è´­ç»ç†å¼ ä¸‰å¯èƒ½å­˜åœ¨å…³è”</li>
                            <li>è¿‘æœŸä¸­æ ‡ç‡å¼‚å¸¸åé«˜ï¼ˆ5ä¸ªé¡¹ç›®ä¸­æ ‡4ä¸ªï¼‰</li>
                            <li>æŠ¥ä»·ä½äºå¸‚åœºå¹³å‡æ°´å¹³15%</li>
                            <li>ä¸­æ ‡çš„é¡¹ç›®å‡ç”±å¼ ä¸‰å®¡æ‰¹</li>
                        </ul>
                    </div>`;
                } else if (riskLevel === 'NORMAL' && isC002) {
                    html += `<div style="background: #f0fdf4; border-left: 3px solid #10b981; padding: 12px; border-radius: 4px;">
                        <h5 style="font-size: 14px; font-weight: 600; color: #059669; margin-bottom: 8px;">âœ“ æ­£å¸¸ä¼ä¸š</h5>
                        <div style="color: #065f46; font-size: 13px;">è¯¥ä¼ä¸šèµ„è´¨é½å…¨ï¼Œå±¥çº¦è®°å½•è‰¯å¥½ï¼Œæœªå‘ç°é‡å¤§é£é™©</div>
                    </div>`;
                }
                
            } else if (node.type === 'CONTRACT') {
                if (node.amount) html += `<div class="detail-item"><label>åˆåŒé‡‘é¢:</label><span style="color: #059669; font-weight: 600;">${node.amount.toLocaleString()} å…ƒ</span></div>`;
                if (node.date) html += `<div class="detail-item"><label>ç­¾è®¢æ—¥æœŸ:</label><span>${node.date}</span></div>`;
                if (node.status) html += `<div class="detail-item"><label>æ‰§è¡ŒçŠ¶æ€:</label><span>${node.status}</span></div>`;
                html += `<div class="detail-item"><label>ç”²æ–¹:</label><span>æŸæŸå¤§å­¦</span></div>`;
                html += `<div class="detail-item"><label>ä¹™æ–¹:</label><span>æŸæŸç§‘æŠ€æœ‰é™å…¬å¸</span></div>`;
                
                html += `</div><div style="margin-bottom: 16px;">
                    <h5 style="font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 8px;">æ‰§è¡Œæƒ…å†µ</h5>
                    <div class="detail-item"><label>å®Œæˆè¿›åº¦:</label><span>65%</span></div>
                    <div class="detail-item"><label>å·²ä»˜æ¬¾:</label><span>320ä¸‡å…ƒ</span></div>
                    <div class="detail-item"><label>è´¨é‡è¯„åˆ†:</label><span>è‰¯å¥½</span></div>
                </div>`;
                
                if (riskLevel === 'HIGH' || riskLevel === 'MEDIUM') {
                    html += `<div style="background: #fffbeb; border-left: 3px solid #f59e0b; padding: 12px; border-radius: 4px;">
                        <h5 style="font-size: 14px; font-weight: 600; color: #d97706; margin-bottom: 8px;">âš ï¸ é£é™©æç¤º</h5>
                        <ul style="margin: 0; padding-left: 20px; color: #92400e; font-size: 13px;">
                            <li>åˆåŒé‡‘é¢è¶…å‡ºé¢„ç®—30%</li>
                            <li>æœªæŒ‰è§„å®šå±¥è¡Œè¿½åŠ é¢„ç®—å®¡æ‰¹</li>
                            <li>ç­¾çº¦äººå‘˜ä¸ä¾›åº”å•†å­˜åœ¨å…³è”</li>
                        </ul>
                    </div>`;
                }
                
            } else if (node.type === 'BID') {
                if (node.amount) html += `<div class="detail-item"><label>é¢„ç®—é‡‘é¢:</label><span style="color: #059669; font-weight: 600;">${node.amount.toLocaleString()} å…ƒ</span></div>`;
                if (node.date) html += `<div class="detail-item"><label>å‘å¸ƒæ—¥æœŸ:</label><span>${node.date}</span></div>`;
                if (node.status) html += `<div class="detail-item"><label>é¡¹ç›®çŠ¶æ€:</label><span>${node.status}</span></div>`;
                html += `<div class="detail-item"><label>æ‹›æ ‡æ–¹å¼:</label><span>å…¬å¼€æ‹›æ ‡</span></div>`;
                html += `<div class="detail-item"><label>æŠ•æ ‡å•ä½:</label><span>8 å®¶</span></div>`;
                
                html += `</div><div style="margin-bottom: 16px;">
                    <h5 style="font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 8px;">ä¸­æ ‡ä¿¡æ¯</h5>
                    <div class="detail-item"><label>ä¸­æ ‡å•ä½:</label><span>æŸæŸç§‘æŠ€æœ‰é™å…¬å¸</span></div>
                    <div class="detail-item"><label>ä¸­æ ‡é‡‘é¢:</label><span>480ä¸‡å…ƒ</span></div>
                    <div class="detail-item"><label>ä¸­æ ‡æ—¥æœŸ:</label><span>2024-03-20</span></div>
                </div>`;
            }
            
            html += '</div>';
            document.getElementById('nodeDetail').innerHTML = html;
            switchTab('node');
        }

        // æ˜¾ç¤ºå…³ç³»è¯¦æƒ…
        function showRelationDetail(edge) {
            console.log('æ˜¾ç¤ºå…³ç³»è¯¦æƒ…:', edge);
            
            // å¦‚æœè¾¹æ•°æ®ä¸å®Œæ•´ï¼Œå°è¯•ä»å›¾è°±æ•°æ®ä¸­è·å–
            if (currentGraph && (!edge.source || !edge.target)) {
                const fullEdge = currentGraph.edges.find(e => e.id === edge.id);
                if (fullEdge) {
                    edge = { ...edge, ...fullEdge };
                }
            }
            
            // è·å–æºèŠ‚ç‚¹å’Œç›®æ ‡èŠ‚ç‚¹çš„åç§°
            let sourceName = edge.source;
            let targetName = edge.target;
            if (currentGraph) {
                const sourceNode = currentGraph.nodes.find(n => n.id === edge.source);
                const targetNode = currentGraph.nodes.find(n => n.id === edge.target);
                if (sourceNode) sourceName = sourceNode.label || sourceNode.name || sourceNode.id;
                if (targetNode) targetName = targetNode.label || targetNode.name || targetNode.id;
            }
            
            const typeNames = {
                'FAMILY': 'äº²å±å…³ç³»',
                'EQUITY': 'è‚¡æƒå…³ç³»',
                'EMPLOYMENT': 'é›‡ä½£å…³ç³»',
                'APPROVAL': 'å®¡æ‰¹å…³ç³»',
                'SIGN': 'ç­¾è®¢å…³ç³»',
                'BID': 'æŠ•æ ‡å…³ç³»',
                'LEGAL_REP': 'æ³•å®šä»£è¡¨äºº',
                'SHAREHOLDER': 'è‚¡ä¸œå…³ç³»'
            };
            
            const riskNames = {
                'HIGH': 'é«˜é£é™©',
                'MEDIUM': 'ä¸­é£é™©',
                'LOW': 'ä½é£é™©',
                'NORMAL': 'æ­£å¸¸'
            };
            
            const edgeLabel = edge.label || typeNames[edge.type] || edge.type;
            const edgeType = typeNames[edge.type] || edge.type;
            const riskLevel = edge.riskLevel || 'NORMAL';
            const riskName = riskNames[riskLevel] || riskLevel;
            
            let html = `
                <div class="detail-content">
                    <div style="border-bottom: 2px solid #e5e7eb; padding-bottom: 12px; margin-bottom: 16px;">
                        <h4 style="font-size: 18px; font-weight: 600; color: #1f2937; margin-bottom: 8px;">${edgeLabel}</h4>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <span style="padding: 4px 12px; background: #f3f4f6; border-radius: 4px; font-size: 12px;">${edgeType}</span>
                            <span class="risk-badge risk-${riskLevel.toLowerCase()}">${riskName}</span>
                            ${edge.isHidden ? '<span style="padding: 4px 12px; background: #fef3c7; color: #92400e; border-radius: 4px; font-size: 12px;">éšè—å…³è”</span>' : ''}
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 16px;">
                        <h5 style="font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 8px;">å…³ç³»ä¿¡æ¯</h5>
            `;
            
            if (sourceName && targetName) {
                html += `<div class="detail-item"><label>èµ·å§‹èŠ‚ç‚¹:</label><span>${sourceName}</span></div>`;
                html += `<div class="detail-item"><label>ç›®æ ‡èŠ‚ç‚¹:</label><span>${targetName}</span></div>`;
            }
            
            // æ ¹æ®å…³ç³»ç±»å‹æ·»åŠ è¯¦ç»†ä¿¡æ¯
            const props = edge.properties || {};
            
            if (edge.type === 'FAMILY') {
                if (props.relation) html += `<div class="detail-item"><label>äº²å±å…³ç³»:</label><span>${props.relation}</span></div>`;
                html += `<div class="detail-item"><label>å‘ç°æ—¶é—´:</label><span>2024-10-15</span></div>`;
                html += `<div class="detail-item"><label>æ•°æ®æ¥æº:</label><span>å…¬å®‰ç³»ç»Ÿ</span></div>`;
            } else if (edge.type === 'EQUITY') {
                if (props.ratio) html += `<div class="detail-item"><label>æŒè‚¡æ¯”ä¾‹:</label><span>${props.ratio}%</span></div>`;
                if (props.amount) html += `<div class="detail-item"><label>æŠ•èµ„é‡‘é¢:</label><span>${props.amount}ä¸‡å…ƒ</span></div>`;
                if (props.since) html += `<div class="detail-item"><label>æŠ•èµ„æ—¶é—´:</label><span>${props.since}</span></div>`;
            } else if (edge.type === 'SIGN') {
                if (props.date) html += `<div class="detail-item"><label>ç­¾è®¢æ—¥æœŸ:</label><span>${props.date}</span></div>`;
                if (props.role) html += `<div class="detail-item"><label>ç­¾çº¦è§’è‰²:</label><span>${props.role}</span></div>`;
                html += `<div class="detail-item"><label>åˆåŒé‡‘é¢:</label><span>500ä¸‡å…ƒ</span></div>`;
            } else if (edge.type === 'APPROVAL') {
                if (props.role) html += `<div class="detail-item"><label>å®¡æ‰¹è§’è‰²:</label><span>${props.role}</span></div>`;
                if (props.date) html += `<div class="detail-item"><label>å®¡æ‰¹æ—¥æœŸ:</label><span>${props.date}</span></div>`;
                html += `<div class="detail-item"><label>å®¡æ‰¹ç»“æœ:</label><span>é€šè¿‡</span></div>`;
            } else if (edge.type === 'LEGAL_REP') {
                if (props.since) html += `<div class="detail-item"><label>ä»»èŒæ—¶é—´:</label><span>${props.since}</span></div>`;
                html += `<div class="detail-item"><label>æ³•äººç±»å‹:</label><span>æ³•å®šä»£è¡¨äºº</span></div>`;
            } else if (edge.type === 'BID') {
                if (props.rank) html += `<div class="detail-item"><label>ä¸­æ ‡æ’å:</label><span>ç¬¬${props.rank}å</span></div>`;
                if (props.score) html += `<div class="detail-item"><label>è¯„åˆ†:</label><span>${props.score}åˆ†</span></div>`;
                html += `<div class="detail-item"><label>æŠ•æ ‡æ—¶é—´:</label><span>2024-03-10</span></div>`;
            } else if (edge.type === 'EMPLOYMENT') {
                if (props.position) html += `<div class="detail-item"><label>èŒä½:</label><span>${props.position}</span></div>`;
                if (props.since) html += `<div class="detail-item"><label>ä»»èŒæ—¶é—´:</label><span>${props.since}</span></div>`;
                html += `<div class="detail-item"><label>é›‡ä½£çŠ¶æ€:</label><span>åœ¨èŒ</span></div>`;
            }
            
            if (edge.confidence) {
                const confidencePercent = (edge.confidence * 100).toFixed(0);
                const confidenceColor = edge.confidence > 0.8 ? '#059669' : edge.confidence > 0.5 ? '#f59e0b' : '#ef4444';
                html += `<div class="detail-item"><label>ç½®ä¿¡åº¦:</label><span style="color: ${confidenceColor}; font-weight: 600;">${confidencePercent}%</span></div>`;
            }
            
            html += `</div>`;
            
            // æ·»åŠ é£é™©åˆ†æ
            if (riskLevel === 'HIGH' || riskLevel === 'MEDIUM') {
                const bgColor = riskLevel === 'HIGH' ? '#fef2f2' : '#fffbeb';
                const borderColor = riskLevel === 'HIGH' ? '#ef4444' : '#f59e0b';
                const textColor = riskLevel === 'HIGH' ? '#dc2626' : '#d97706';
                const listColor = riskLevel === 'HIGH' ? '#991b1b' : '#92400e';
                
                html += `<div style="background: ${bgColor}; border-left: 3px solid ${borderColor}; padding: 12px; border-radius: 4px; margin-bottom: 16px;">
                    <h5 style="font-size: 14px; font-weight: 600; color: ${textColor}; margin-bottom: 8px;">âš ï¸ é£é™©åˆ†æ</h5>
                    <ul style="margin: 0; padding-left: 20px; color: ${listColor}; font-size: 13px;">
                        <li>è¯¥å…³ç³»å¯èƒ½å¯¼è‡´åˆ©ç›Šå†²çª</li>
                        <li>è¿åå›é¿åˆ¶åº¦ç›¸å…³è§„å®š</li>
                        <li>éœ€è¦è¿›ä¸€æ­¥æ ¸æŸ¥å’Œå¤„ç†</li>
                    </ul>
                </div>`;
            }
            
            // æ·»åŠ å¤„ç½®å»ºè®®
            html += `<div style="background: #f0fdf4; border-left: 3px solid #10b981; padding: 12px; border-radius: 4px;">
                <h5 style="font-size: 14px; font-weight: 600; color: #059669; margin-bottom: 8px;">ğŸ’¡ å¤„ç½®å»ºè®®</h5>
                <ul style="margin: 0; padding-left: 20px; color: #065f46; font-size: 13px;">
                    <li>å¯åŠ¨å…³è”å…³ç³»æ ¸æŸ¥ç¨‹åº</li>
                    <li>è¦æ±‚ç›¸å…³äººå‘˜è¯´æ˜æƒ…å†µ</li>
                    <li>è¯„ä¼°æ˜¯å¦éœ€è¦å›é¿æˆ–è°ƒæ•´</li>
                    <li>å»ºç«‹é•¿æœŸç›‘æ§æœºåˆ¶</li>
                </ul>
            </div>`;
            
            html += '</div>';
            document.getElementById('relationDetail').innerHTML = html;
            switchTab('relation');
        }

        // æ›´æ–°å›¾è°±åˆ†æç»“æœï¼ˆä¸åˆ‡æ¢æ ‡ç­¾é¡µï¼‰
        function updateGraphAnalysis(graph) {
            console.log('updateGraphAnalysis è¢«è°ƒç”¨ï¼Œå›¾è°±æ•°æ®:', graph);
            const highRiskNodes = graph.nodes.filter(n => n.riskLevel === 'HIGH').length;
            const mediumRiskNodes = graph.nodes.filter(n => n.riskLevel === 'MEDIUM').length;
            const highRiskEdges = graph.edges.filter(e => e.riskLevel === 'HIGH').length;
            
            console.log('ç»Ÿè®¡æ•°æ® - é«˜é£é™©èŠ‚ç‚¹:', highRiskNodes, 'ä¸­é£é™©èŠ‚ç‚¹:', mediumRiskNodes, 'é«˜é£é™©è¾¹:', highRiskEdges);
            
            let html = `
                <div class="detail-content">
                    <div style="border-bottom: 2px solid #e5e7eb; padding-bottom: 12px; margin-bottom: 16px;">
                        <h4 style="font-size: 18px; font-weight: 600; color: #1f2937;">å›¾è°±åˆ†æç»“æœ</h4>
                    </div>
                    
                    <div style="margin-bottom: 16px;">
                        <h5 style="font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 8px;">æ•´ä½“æ¦‚å†µ</h5>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                            <div style="background: #f9fafb; padding: 12px; border-radius: 6px;">
                                <div style="font-size: 12px; color: #6b7280; margin-bottom: 4px;">èŠ‚ç‚¹æ€»æ•°</div>
                                <div style="font-size: 24px; font-weight: 600; color: #1f2937;">${graph.nodes.length}</div>
                            </div>
                            <div style="background: #f9fafb; padding: 12px; border-radius: 6px;">
                                <div style="font-size: 12px; color: #6b7280; margin-bottom: 4px;">å…³ç³»æ€»æ•°</div>
                                <div style="font-size: 24px; font-weight: 600; color: #1f2937;">${graph.edges.length}</div>
                            </div>
                            <div style="background: #fef2f2; padding: 12px; border-radius: 6px;">
                                <div style="font-size: 12px; color: #991b1b; margin-bottom: 4px;">é«˜é£é™©èŠ‚ç‚¹</div>
                                <div style="font-size: 24px; font-weight: 600; color: #dc2626;">${highRiskNodes}</div>
                            </div>
                            <div style="background: #fffbeb; padding: 12px; border-radius: 6px;">
                                <div style="font-size: 12px; color: #92400e; margin-bottom: 4px;">ä¸­é£é™©èŠ‚ç‚¹</div>
                                <div style="font-size: 24px; font-weight: 600; color: #f59e0b;">${mediumRiskNodes}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 16px;">
                        <h5 style="font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 8px;">å…³é”®å‘ç°</h5>
                        <div style="background: #fef2f2; border-left: 3px solid #ef4444; padding: 12px; border-radius: 4px; margin-bottom: 8px;">
                            <div style="font-weight: 600; color: #dc2626; margin-bottom: 4px;">ğŸ”´ å‘ç°åˆ©ç›Šå…³è”é“¾</div>
                            <div style="font-size: 13px; color: #991b1b; line-height: 1.8;">
                                <strong>å¼ ä¸‰ä¸æŸæŸç§‘æŠ€å…¬å¸çš„å…³è”è·¯å¾„ï¼š</strong><br>
                                â€¢ è·¯å¾„1: å¼ ä¸‰ï¼ˆé‡‡è´­ç»ç†ï¼‰â†’ å®¡æ‰¹ â†’ åŠå…¬è®¾å¤‡é‡‡è´­é¡¹ç›® â† ä¸­æ ‡ â† æŸæŸç§‘æŠ€å…¬å¸<br>
                                â€¢ è·¯å¾„2: å¼ ä¸‰ï¼ˆé‡‡è´­ç»ç†ï¼‰â†’ å®¡æ‰¹ â†’ åŠå…¬è®¾å¤‡é‡‡è´­åˆåŒ â† ç­¾çº¦ â† æŸæŸç§‘æŠ€å…¬å¸<br>
                                â€¢ å…³è”è¯´æ˜: æŸæŸç§‘æŠ€å…¬å¸çš„æ³•äººæ˜¯ç‹äº”ï¼Œè¯¥å…¬å¸ä¸­æ ‡äº†å¼ ä¸‰å®¡æ‰¹çš„é¡¹ç›®
                            </div>
                        </div>
                        <div style="background: #fffbeb; border-left: 3px solid #f59e0b; padding: 12px; border-radius: 4px; margin-bottom: 8px;">
                            <div style="font-weight: 600; color: #d97706; margin-bottom: 4px;">ğŸŸ¡ å‘ç°å¼‚å¸¸äº¤æ˜“æ¨¡å¼</div>
                            <div style="font-size: 13px; color: #92400e;">æŸæŸç§‘æŠ€å…¬å¸åœ¨6ä¸ªæœˆå†…ä¸­æ ‡${highRiskEdges}ä¸ªé¡¹ç›®ï¼Œä¸­æ ‡ç‡å¼‚å¸¸åé«˜ï¼Œä¸”å‡ç”±å¼ ä¸‰å®¡æ‰¹</div>
                        </div>
                        <div style="background: #f0fdf4; border-left: 3px solid #10b981; padding: 12px; border-radius: 4px;">
                            <div style="font-weight: 600; color: #059669; margin-bottom: 4px;">ğŸŸ¢ æ­£å¸¸ä¸šåŠ¡å…³ç³»</div>
                            <div style="font-size: 13px; color: #065f46;">å…¶ä»–${graph.edges.length - highRiskEdges}ä¸ªå…³ç³»æœªå‘ç°æ˜æ˜¾å¼‚å¸¸</div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 16px;">
                        <h5 style="font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 8px;">é£é™©è·¯å¾„è¯¦ç»†åˆ†æ</h5>
                        <div style="background: #fff2f0; padding: 12px; border-radius: 6px; border-left: 3px solid #ff4d4f; margin-bottom: 8px;">
                            <div style="font-size: 13px; color: #374151; margin-bottom: 8px;">
                                <strong style="color: #dc2626;">é«˜é£é™©è·¯å¾„1: å¼ ä¸‰ â†’ æŸæŸç§‘æŠ€å…¬å¸ï¼ˆé€šè¿‡é¡¹ç›®å®¡æ‰¹ï¼‰</strong>
                            </div>
                            <div style="font-size: 12px; color: #666; line-height: 1.8; margin-bottom: 8px;">
                                å®Œæ•´è·¯å¾„: å¼ ä¸‰ï¼ˆé‡‡è´­ç»ç†ï¼‰â†’ å®¡æ‰¹ â†’ åŠå…¬è®¾å¤‡é‡‡è´­é¡¹ç›® â† ä¸­æ ‡ â† æŸæŸç§‘æŠ€å…¬å¸ â† æ³•äººä»£è¡¨ â† ç‹äº”
                            </div>
                            <div style="font-size: 12px; color: #6b7280;">
                                é£é™©ç­‰çº§: <span style="color: #dc2626; font-weight: 600;">é«˜</span> | 
                                æ¶‰åŠé‡‘é¢: <span style="font-weight: 600;">50ä¸‡å…ƒ</span> | 
                                é£é™©æè¿°: é‡‡è´­ç»ç†å®¡æ‰¹çš„é¡¹ç›®è¢«å…¶å¯èƒ½è®¤è¯†çš„äººçš„å…¬å¸ä¸­æ ‡
                            </div>
                        </div>
                        <div style="background: #fff2f0; padding: 12px; border-radius: 6px; border-left: 3px solid #ff4d4f; margin-bottom: 8px;">
                            <div style="font-size: 13px; color: #374151; margin-bottom: 8px;">
                                <strong style="color: #dc2626;">é«˜é£é™©è·¯å¾„2: å¼ ä¸‰ â†’ æŸæŸç§‘æŠ€å…¬å¸ï¼ˆé€šè¿‡åˆåŒå®¡æ‰¹ï¼‰</strong>
                            </div>
                            <div style="font-size: 12px; color: #666; line-height: 1.8; margin-bottom: 8px;">
                                å®Œæ•´è·¯å¾„: å¼ ä¸‰ï¼ˆé‡‡è´­ç»ç†ï¼‰â†’ å®¡æ‰¹ â†’ åŠå…¬è®¾å¤‡é‡‡è´­åˆåŒ â† ç­¾çº¦ â† æŸæŸç§‘æŠ€å…¬å¸
                            </div>
                            <div style="font-size: 12px; color: #6b7280;">
                                é£é™©ç­‰çº§: <span style="color: #dc2626; font-weight: 600;">é«˜</span> | 
                                æ¶‰åŠé‡‘é¢: <span style="font-weight: 600;">50ä¸‡å…ƒ</span> | 
                                é£é™©æè¿°: é‡‡è´­äººå‘˜ç›´æ¥å®¡æ‰¹ä¾›åº”å•†åˆåŒï¼Œå­˜åœ¨åˆ©ç›Šè¾“é€é£é™©
                            </div>
                        </div>
                        <div style="background: #fffbeb; padding: 12px; border-radius: 6px; border-left: 3px solid #faad14;">
                            <div style="font-size: 13px; color: #374151; margin-bottom: 8px;">
                                <strong style="color: #d97706;">ä¸­é£é™©è·¯å¾„: æå›› â†’ æŸæŸå»ºç­‘å·¥ç¨‹å…¬å¸</strong>
                            </div>
                            <div style="font-size: 12px; color: #666; line-height: 1.8; margin-bottom: 8px;">
                                å®Œæ•´è·¯å¾„: æå››ï¼ˆè´¢åŠ¡æ€»ç›‘ï¼‰â†’ ä»»èŒè‘£äº‹ â†’ æŸæŸå»ºç­‘å·¥ç¨‹å…¬å¸ â†’ ç­¾çº¦ â†’ å®éªŒå®¤å»ºè®¾åˆåŒ â† å®¡æ‰¹ â† æå››
                            </div>
                            <div style="font-size: 12px; color: #6b7280;">
                                é£é™©ç­‰çº§: <span style="color: #f59e0b; font-weight: 600;">ä¸­</span> | 
                                æ¶‰åŠé‡‘é¢: <span style="font-weight: 600;">200ä¸‡å…ƒ</span> | 
                                é£é™©æè¿°: è´¢åŠ¡äººå‘˜åœ¨ä¾›åº”å•†ä¼ä¸šä»»èŒå¹¶å®¡æ‰¹è¯¥ä¼ä¸šåˆåŒ
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: #eff6ff; border-left: 3px solid #3b82f6; padding: 12px; border-radius: 4px;">
                        <h5 style="font-size: 14px; font-weight: 600; color: #1e40af; margin-bottom: 8px;">ğŸ“‹ å¤„ç½®å»ºè®®</h5>
                        <ol style="margin: 0; padding-left: 20px; color: #1e3a8a; font-size: 13px;">
                            <li style="margin-bottom: 4px;">ç«‹å³å¯åŠ¨å¯¹å¼ ä¸‰å’Œç‹äº”å…³è”å…³ç³»çš„ä¸“é¡¹è°ƒæŸ¥</li>
                            <li style="margin-bottom: 4px;">æš‚åœæŸæŸç§‘æŠ€å…¬å¸å‚ä¸æ–°é¡¹ç›®æŠ•æ ‡èµ„æ ¼</li>
                            <li style="margin-bottom: 4px;">å¯¹å·²ç­¾è®¢åˆåŒè¿›è¡Œåˆè§„æ€§å®¡æŸ¥</li>
                            <li style="margin-bottom: 4px;">å®Œå–„é‡‡è´­äººå‘˜å›é¿åˆ¶åº¦å’Œå…³è”å…³ç³»ç”³æŠ¥æœºåˆ¶</li>
                            <li>å»ºç«‹ä¾›åº”å•†å¼‚å¸¸è¡Œä¸ºç›‘æ§é¢„è­¦ç³»ç»Ÿ</li>
                        </ol>
                    </div>
                </div>
            `;
            
            const analysisDetailEl = document.getElementById('analysisDetail');
            console.log('analysisDetail å…ƒç´ :', analysisDetailEl);
            console.log('å‡†å¤‡è®¾ç½® innerHTMLï¼Œå†…å®¹é•¿åº¦:', html.length);
            analysisDetailEl.innerHTML = html;
            console.log('innerHTML å·²è®¾ç½®å®Œæˆ');
        }
        
        // æ˜¾ç¤ºåˆ†æç»“æœï¼ˆé€šç”¨ï¼‰
        function showAnalysisResult(title, data) {
            let html = `<div class="detail-content"><h4>${title}</h4>`;
            
            if (data.summary) {
                html += '<div class="summary-stats">';
                html += `<div class="stat-item"><label>èŠ‚ç‚¹æ•°:</label><span>${data.summary.totalNodes}</span></div>`;
                html += `<div class="stat-item"><label>è¾¹æ•°:</label><span>${data.summary.totalEdges}</span></div>`;
                html += `<div class="stat-item"><label>é«˜é£é™©:</label><span class="risk-high">${data.summary.highRiskPaths || data.summary.highRiskNodes || 0}</span></div>`;
                html += '</div>';
            }
            
            html += '</div>';
            document.getElementById('analysisDetail').innerHTML = html;
        }

        // åˆ‡æ¢æ ‡ç­¾é¡µ
        function switchTab(tab) {
            console.log('switchTab è¢«è°ƒç”¨ï¼Œç›®æ ‡æ ‡ç­¾:', tab);
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // æ¿€æ´»å¯¹åº”çš„æ ‡ç­¾æŒ‰é’®
            const tabMap = {
                'node': 0,
                'relation': 1,
                'analysis': 2
            };
            const tabIndex = tabMap[tab];
            console.log('æ ‡ç­¾ç´¢å¼•:', tabIndex);
            if (tabIndex !== undefined) {
                const tabBtns = document.querySelectorAll('.tab-btn');
                console.log('æ‰¾åˆ°çš„æ ‡ç­¾æŒ‰é’®æ•°é‡:', tabBtns.length);
                if (tabBtns[tabIndex]) {
                    tabBtns[tabIndex].classList.add('active');
                    console.log('å·²æ¿€æ´»æ ‡ç­¾æŒ‰é’®:', tabIndex);
                }
            }
            
            // æ¿€æ´»å¯¹åº”çš„å†…å®¹åŒºåŸŸ
            const contentEl = document.getElementById(tab + 'Detail');
            console.log('å†…å®¹å…ƒç´  ID:', tab + 'Detail', 'å…ƒç´ :', contentEl);
            if (contentEl) {
                contentEl.classList.add('active');
                console.log('å·²æ¿€æ´»å†…å®¹åŒºåŸŸ');
            } else {
                console.error('æœªæ‰¾åˆ°å†…å®¹å…ƒç´ :', tab + 'Detail');
            }
        }

        // æ›´æ–°å›¾è°±ç»Ÿè®¡
        function updateGraphStats(graph) {
            document.getElementById('graphStats').textContent = 
                `èŠ‚ç‚¹: ${graph.nodes.length} | è¾¹: ${graph.edges.length}`;
        }

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        function showLoading(show) {
            document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
        }

        // è·å–é€‰ä¸­çš„å¤é€‰æ¡†å€¼
        function getCheckedValues(selector) {
            return Array.from(document.querySelectorAll(selector))
                .filter(cb => cb.checked)
                .map(cb => cb.value);
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
