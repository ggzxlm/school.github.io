<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è°ƒè¯•å…³ç³»åˆ†æ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: #f5f5f5;
        }
        
        .container {
            display: flex;
            height: 100vh;
        }
        
        .sidebar {
            width: 300px;
            background: white;
            padding: 20px;
            overflow-y: auto;
            border-right: 1px solid #e0e0e0;
        }
        
        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .tabs {
            display: flex;
            background: white;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .tab {
            padding: 15px 30px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .tab:hover {
            background: #f5f5f5;
        }
        
        .tab.active {
            border-bottom-color: #1890ff;
            color: #1890ff;
            font-weight: 600;
        }
        
        .content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: white;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        h2 {
            margin-bottom: 15px;
            color: #333;
        }
        
        h3 {
            margin: 20px 0 10px;
            color: #666;
            font-size: 16px;
        }
        
        button {
            width: 100%;
            padding: 12px;
            margin-bottom: 10px;
            background: #1890ff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }
        
        button:hover {
            background: #40a9ff;
        }
        
        button.secondary {
            background: #52c41a;
        }
        
        button.secondary:hover {
            background: #73d13d;
        }
        
        select {
            width: 100%;
            padding: 8px;
            margin-bottom: 15px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .info-box {
            padding: 15px;
            background: #f0f5ff;
            border-left: 3px solid #1890ff;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        
        .success-box {
            padding: 15px;
            background: #f6ffed;
            border-left: 3px solid #52c41a;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        
        .error-box {
            padding: 15px;
            background: #fff2f0;
            border-left: 3px solid #ff4d4f;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        
        .stat-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            padding: 15px;
            background: #fafafa;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-label {
            font-size: 12px;
            color: #999;
            margin-bottom: 5px;
        }
        
        .stat-value {
            font-size: 28px;
            font-weight: 600;
            color: #333;
        }
        
        .node-list, .edge-list {
            list-style: none;
        }
        
        .node-item, .edge-item {
            padding: 12px;
            background: #fafafa;
            border-radius: 4px;
            margin-bottom: 8px;
            border-left: 3px solid #1890ff;
        }
        
        .node-item.high-risk {
            border-left-color: #ff4d4f;
            background: #fff2f0;
        }
        
        .node-item.medium-risk {
            border-left-color: #faad14;
            background: #fffbeb;
        }
        
        .node-name {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .node-meta {
            font-size: 12px;
            color: #666;
        }
        
        .risk-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 8px;
        }
        
        .risk-high {
            background: #ff4d4f;
            color: white;
        }
        
        .risk-medium {
            background: #faad14;
            color: white;
        }
        
        .risk-low {
            background: #52c41a;
            color: white;
        }
        
        .risk-normal {
            background: #d9d9d9;
            color: #666;
        }
        
        .path-item {
            padding: 15px;
            background: #fafafa;
            border-radius: 4px;
            margin-bottom: 12px;
        }
        
        .path-chain {
            font-size: 14px;
            color: #333;
            margin-bottom: 8px;
            line-height: 1.6;
        }
        
        .path-info {
            font-size: 12px;
            color: #666;
        }
        
        pre {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
            line-height: 1.5;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å·¦ä¾§æ§åˆ¶é¢æ¿ -->
        <div class="sidebar">
            <h2>æ§åˆ¶é¢æ¿</h2>
            
            <h3>é€‰æ‹©å®ä½“</h3>
            <select id="entitySelect" multiple size="8">
                <option value="P001">å¼ ä¸‰ (é‡‡è´­ç»ç†)</option>
                <option value="P002">æå›› (è´¢åŠ¡æ€»ç›‘)</option>
                <option value="P003">ç‹äº”</option>
                <option value="C001">æŸæŸç§‘æŠ€æœ‰é™å…¬å¸</option>
                <option value="C002">æŸæŸå»ºç­‘å·¥ç¨‹å…¬å¸</option>
                <option value="CT001">åŠå…¬è®¾å¤‡é‡‡è´­åˆåŒ</option>
                <option value="CT002">å®éªŒå®¤å»ºè®¾åˆåŒ</option>
                <option value="B001">åŠå…¬è®¾å¤‡é‡‡è´­é¡¹ç›®</option>
            </select>
            
            <h3>å…³è”æ·±åº¦</h3>
            <select id="depthSelect">
                <option value="1">1å±‚</option>
                <option value="2" selected>2å±‚</option>
                <option value="3">3å±‚</option>
            </select>
            
            <button onclick="buildGraph()">æ„å»ºå›¾è°±</button>
            <button class="secondary" onclick="showAnalysis()">æŸ¥çœ‹åˆ†æç»“æœ</button>
        </div>
        
        <!-- å³ä¾§å†…å®¹åŒº -->
        <div class="main">
            <div class="tabs">
                <div class="tab active" onclick="switchTab('overview')">æ¦‚è§ˆ</div>
                <div class="tab" onclick="switchTab('nodes')">èŠ‚ç‚¹è¯¦æƒ…</div>
                <div class="tab" onclick="switchTab('edges')">å…³ç³»è¯¦æƒ…</div>
                <div class="tab" onclick="switchTab('analysis')">åˆ†æç»“æœ</div>
                <div class="tab" onclick="switchTab('debug')">è°ƒè¯•ä¿¡æ¯</div>
            </div>
            
            <div class="content">
                <!-- æ¦‚è§ˆæ ‡ç­¾é¡µ -->
                <div id="overview" class="tab-content active">
                    <h2>å›¾è°±æ¦‚è§ˆ</h2>
                    <div class="info-box">
                        <strong>æç¤ºï¼š</strong>è¯·åœ¨å·¦ä¾§é€‰æ‹©å®ä½“ï¼Œç„¶åç‚¹å‡»"æ„å»ºå›¾è°±"æŒ‰é’®
                    </div>
                    <div id="overviewContent">
                        <p style="color: #999; text-align: center; padding: 40px;">æš‚æ— æ•°æ®</p>
                    </div>
                </div>
                
                <!-- èŠ‚ç‚¹è¯¦æƒ…æ ‡ç­¾é¡µ -->
                <div id="nodes" class="tab-content">
                    <h2>èŠ‚ç‚¹è¯¦æƒ…</h2>
                    <div id="nodesContent">
                        <p style="color: #999; text-align: center; padding: 40px;">æš‚æ— æ•°æ®</p>
                    </div>
                </div>
                
                <!-- å…³ç³»è¯¦æƒ…æ ‡ç­¾é¡µ -->
                <div id="edges" class="tab-content">
                    <h2>å…³ç³»è¯¦æƒ…</h2>
                    <div id="edgesContent">
                        <p style="color: #999; text-align: center; padding: 40px;">æš‚æ— æ•°æ®</p>
                    </div>
                </div>
                
                <!-- åˆ†æç»“æœæ ‡ç­¾é¡µ -->
                <div id="analysis" class="tab-content">
                    <h2>åˆ†æç»“æœ</h2>
                    <div id="analysisContent">
                        <p style="color: #999; text-align: center; padding: 40px;">æš‚æ— æ•°æ®</p>
                    </div>
                </div>
                
                <!-- è°ƒè¯•ä¿¡æ¯æ ‡ç­¾é¡µ -->
                <div id="debug" class="tab-content">
                    <h2>è°ƒè¯•ä¿¡æ¯</h2>
                    <div id="debugContent">
                        <pre id="debugLog">ç­‰å¾…æ“ä½œ...</pre>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="js/relation-graph-service.js"></script>
    <script>
        let currentGraph = null;
        
        // æ—¥å¿—å‡½æ•°
        function log(message) {
            const debugLog = document.getElementById('debugLog');
            const timestamp = new Date().toLocaleTimeString();
            debugLog.textContent += `\n[${timestamp}] ${message}`;
            console.log(message);
        }
        
        // åˆå§‹åŒ–
        async function init() {
            try {
                log('æ­£åœ¨åˆå§‹åŒ–æœåŠ¡...');
                await window.relationGraphService.initialize();
                log('âœ“ æœåŠ¡åˆå§‹åŒ–æˆåŠŸ');
            } catch (error) {
                log('âœ— åˆå§‹åŒ–å¤±è´¥: ' + error.message);
                console.error(error);
            }
        }
        
        // æ„å»ºå›¾è°±
        async function buildGraph() {
            try {
                const entitySelect = document.getElementById('entitySelect');
                const depthSelect = document.getElementById('depthSelect');
                
                const selectedEntities = Array.from(entitySelect.selectedOptions).map(opt => opt.value);
                const depth = parseInt(depthSelect.value);
                
                if (selectedEntities.length === 0) {
                    alert('è¯·é€‰æ‹©è‡³å°‘ä¸€ä¸ªå®ä½“');
                    return;
                }
                
                log(`å¼€å§‹æ„å»ºå›¾è°±: å®ä½“=${selectedEntities.join(',')}, æ·±åº¦=${depth}`);
                
                currentGraph = await window.relationGraphService.buildGraph({
                    entityIds: selectedEntities,
                    depth: depth
                });
                
                log(`âœ“ å›¾è°±æ„å»ºæˆåŠŸ: ${currentGraph.nodes.length}ä¸ªèŠ‚ç‚¹, ${currentGraph.edges.length}æ¡è¾¹`);
                
                // æ›´æ–°å„ä¸ªæ ‡ç­¾é¡µ
                updateOverview();
                updateNodes();
                updateEdges();
                updateAnalysis();
                
                // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                showSuccess('å›¾è°±æ„å»ºæˆåŠŸï¼');
                
            } catch (error) {
                log('âœ— æ„å»ºå›¾è°±å¤±è´¥: ' + error.message);
                console.error(error);
                alert('æ„å»ºå›¾è°±å¤±è´¥: ' + error.message);
            }
        }
        
        // æ›´æ–°æ¦‚è§ˆ
        function updateOverview() {
            if (!currentGraph) return;
            
            const highRiskNodes = currentGraph.nodes.filter(n => n.riskLevel === 'HIGH').length;
            const mediumRiskNodes = currentGraph.nodes.filter(n => n.riskLevel === 'MEDIUM').length;
            const highRiskEdges = currentGraph.edges.filter(e => e.riskLevel === 'HIGH').length;
            
            const html = `
                <div class="success-box">
                    <strong>âœ“ å›¾è°±æ„å»ºæˆåŠŸ</strong><br>
                    æ„å»ºæ—¶é—´: ${new Date(currentGraph.metadata.createdAt).toLocaleString()}
                </div>
                
                <div class="stat-grid">
                    <div class="stat-card">
                        <div class="stat-label">èŠ‚ç‚¹æ€»æ•°</div>
                        <div class="stat-value">${currentGraph.nodes.length}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">å…³ç³»æ€»æ•°</div>
                        <div class="stat-value">${currentGraph.edges.length}</div>
                    </div>
                    <div class="stat-card" style="background: #fff2f0;">
                        <div class="stat-label">é«˜é£é™©èŠ‚ç‚¹</div>
                        <div class="stat-value" style="color: #ff4d4f;">${highRiskNodes}</div>
                    </div>
                    <div class="stat-card" style="background: #fffbeb;">
                        <div class="stat-label">ä¸­é£é™©èŠ‚ç‚¹</div>
                        <div class="stat-value" style="color: #faad14;">${mediumRiskNodes}</div>
                    </div>
                </div>
                
                <h3>èŠ‚ç‚¹ç±»å‹åˆ†å¸ƒ</h3>
                <div style="margin-bottom: 20px;">
                    ${getNodeTypeStats()}
                </div>
                
                <h3>å…³ç³»ç±»å‹åˆ†å¸ƒ</h3>
                <div>
                    ${getEdgeTypeStats()}
                </div>
            `;
            
            document.getElementById('overviewContent').innerHTML = html;
        }
        
        // è·å–èŠ‚ç‚¹ç±»å‹ç»Ÿè®¡
        function getNodeTypeStats() {
            const types = {};
            currentGraph.nodes.forEach(node => {
                types[node.type] = (types[node.type] || 0) + 1;
            });
            
            const typeNames = {
                'PERSON': 'äººå‘˜',
                'COMPANY': 'ä¼ä¸š',
                'CONTRACT': 'åˆåŒ',
                'BID': 'æŠ•æ ‡é¡¹ç›®'
            };
            
            return Object.entries(types).map(([type, count]) => 
                `<div style="padding: 8px; background: #fafafa; border-radius: 4px; margin-bottom: 5px;">
                    ${typeNames[type] || type}: <strong>${count}</strong>
                </div>`
            ).join('');
        }
        
        // è·å–è¾¹ç±»å‹ç»Ÿè®¡
        function getEdgeTypeStats() {
            const types = {};
            currentGraph.edges.forEach(edge => {
                types[edge.type] = (types[edge.type] || 0) + 1;
            });
            
            return Object.entries(types).map(([type, count]) => 
                `<div style="padding: 8px; background: #fafafa; border-radius: 4px; margin-bottom: 5px;">
                    ${edge.label || type}: <strong>${count}</strong>
                </div>`
            ).join('');
        }
        
        // æ›´æ–°èŠ‚ç‚¹åˆ—è¡¨
        function updateNodes() {
            if (!currentGraph) return;
            
            const html = `
                <ul class="node-list">
                    ${currentGraph.nodes.map(node => `
                        <li class="node-item ${node.riskLevel === 'HIGH' ? 'high-risk' : node.riskLevel === 'MEDIUM' ? 'medium-risk' : ''}">
                            <div class="node-name">
                                ${node.label}
                                <span class="risk-badge risk-${node.riskLevel.toLowerCase()}">${node.riskLevel}</span>
                            </div>
                            <div class="node-meta">
                                ç±»å‹: ${node.type} | ID: ${node.id}
                                ${node.properties.department ? `| éƒ¨é—¨: ${node.properties.department}` : ''}
                                ${node.properties.position ? `| èŒä½: ${node.properties.position}` : ''}
                            </div>
                        </li>
                    `).join('')}
                </ul>
            `;
            
            document.getElementById('nodesContent').innerHTML = html;
        }
        
        // æ›´æ–°å…³ç³»åˆ—è¡¨
        function updateEdges() {
            if (!currentGraph) return;
            
            const html = `
                <ul class="edge-list">
                    ${currentGraph.edges.map(edge => {
                        const sourceNode = currentGraph.nodes.find(n => n.id === edge.source);
                        const targetNode = currentGraph.nodes.find(n => n.id === edge.target);
                        return `
                            <li class="node-item ${edge.riskLevel === 'HIGH' ? 'high-risk' : edge.riskLevel === 'MEDIUM' ? 'medium-risk' : ''}">
                                <div class="node-name">
                                    ${sourceNode?.label || edge.source} â†’ ${edge.label} â†’ ${targetNode?.label || edge.target}
                                    <span class="risk-badge risk-${edge.riskLevel.toLowerCase()}">${edge.riskLevel}</span>
                                </div>
                                <div class="node-meta">
                                    ç±»å‹: ${edge.type} | ID: ${edge.id}
                                </div>
                            </li>
                        `;
                    }).join('')}
                </ul>
            `;
            
            document.getElementById('edgesContent').innerHTML = html;
        }
        
        // æ›´æ–°åˆ†æç»“æœ
        function updateAnalysis() {
            if (!currentGraph) return;
            
            const highRiskNodes = currentGraph.nodes.filter(n => n.riskLevel === 'HIGH');
            const highRiskEdges = currentGraph.edges.filter(e => e.riskLevel === 'HIGH');
            
            const html = `
                <div class="info-box">
                    <strong>åˆ†æå®Œæˆ</strong><br>
                    å‘ç° ${highRiskNodes.length} ä¸ªé«˜é£é™©èŠ‚ç‚¹å’Œ ${highRiskEdges.length} ä¸ªé«˜é£é™©å…³ç³»
                </div>
                
                <h3>ğŸ”´ é«˜é£é™©èŠ‚ç‚¹</h3>
                ${highRiskNodes.length > 0 ? `
                    <ul class="node-list">
                        ${highRiskNodes.map(node => `
                            <li class="node-item high-risk">
                                <div class="node-name">${node.label}</div>
                                <div class="node-meta">ç±»å‹: ${node.type}</div>
                            </li>
                        `).join('')}
                    </ul>
                ` : '<p style="color: #999;">æœªå‘ç°é«˜é£é™©èŠ‚ç‚¹</p>'}
                
                <h3>âš ï¸ é£é™©è·¯å¾„åˆ†æ</h3>
                <div class="path-item" style="border-left: 3px solid #ff4d4f;">
                    <div class="path-chain">
                        <strong>é«˜é£é™©è·¯å¾„1:</strong> å¼ ä¸‰ä¸æŸæŸç§‘æŠ€å…¬å¸çš„å…³è”é“¾<br>
                        <span style="color: #666; font-size: 13px; line-height: 2;">
                        å¼ ä¸‰ï¼ˆé‡‡è´­ç»ç†ï¼‰â†’ å®¡æ‰¹ â†’ åŠå…¬è®¾å¤‡é‡‡è´­é¡¹ç›® â† ä¸­æ ‡ â† æŸæŸç§‘æŠ€å…¬å¸ â† æ³•äºº â† ç‹äº”
                        </span>
                    </div>
                    <div class="path-info">
                        é£é™©ç­‰çº§: <span class="risk-badge risk-high">é«˜</span> | 
                        æ¶‰åŠé‡‘é¢: 50ä¸‡å…ƒ | 
                        é£é™©æè¿°: é‡‡è´­å®¡æ‰¹äººå®¡æ‰¹çš„é¡¹ç›®ç”±å…¶å¯èƒ½è®¤è¯†çš„äººçš„å…¬å¸ä¸­æ ‡
                    </div>
                </div>
                
                <div class="path-item" style="border-left: 3px solid #ff4d4f;">
                    <div class="path-chain">
                        <strong>é«˜é£é™©è·¯å¾„2:</strong> å¼ ä¸‰ç›´æ¥å®¡æ‰¹äº†æŸæŸç§‘æŠ€å…¬å¸çš„åˆåŒ<br>
                        <span style="color: #666; font-size: 13px; line-height: 2;">
                        å¼ ä¸‰ï¼ˆé‡‡è´­ç»ç†ï¼‰â†’ å®¡æ‰¹ â†’ åŠå…¬è®¾å¤‡é‡‡è´­åˆåŒ â† ç­¾çº¦ â† æŸæŸç§‘æŠ€å…¬å¸
                        </span>
                    </div>
                    <div class="path-info">
                        é£é™©ç­‰çº§: <span class="risk-badge risk-high">é«˜</span> | 
                        æ¶‰åŠé‡‘é¢: 50ä¸‡å…ƒ | 
                        é£é™©æè¿°: é‡‡è´­äººå‘˜ç›´æ¥å®¡æ‰¹ä¾›åº”å•†åˆåŒï¼Œå­˜åœ¨åˆ©ç›Šè¾“é€é£é™©
                    </div>
                </div>
                
                <div class="path-item" style="border-left: 3px solid #faad14;">
                    <div class="path-chain">
                        <strong>ä¸­é£é™©è·¯å¾„:</strong> æå››ä¸æŸæŸå»ºç­‘å·¥ç¨‹å…¬å¸çš„å…³è”<br>
                        <span style="color: #666; font-size: 13px; line-height: 2;">
                        æå››ï¼ˆè´¢åŠ¡æ€»ç›‘ï¼‰â†’ ä»»èŒè‘£äº‹ â†’ æŸæŸå»ºç­‘å·¥ç¨‹å…¬å¸ â†’ ç­¾çº¦ â†’ å®éªŒå®¤å»ºè®¾åˆåŒ â† å®¡æ‰¹ â† æå››
                        </span>
                    </div>
                    <div class="path-info">
                        é£é™©ç­‰çº§: <span class="risk-badge risk-medium">ä¸­</span> | 
                        æ¶‰åŠé‡‘é¢: 200ä¸‡å…ƒ | 
                        é£é™©æè¿°: è´¢åŠ¡äººå‘˜åœ¨ä¾›åº”å•†ä¼ä¸šä»»èŒå¹¶å®¡æ‰¹è¯¥ä¼ä¸šåˆåŒ
                    </div>
                </div>
                
                <h3>ğŸ“‹ å¤„ç½®å»ºè®®</h3>
                <div style="background: #f0f5ff; padding: 15px; border-radius: 4px;">
                    <ol style="padding-left: 20px; line-height: 1.8;">
                        <li>ç«‹å³å¯åŠ¨å¯¹å¼ ä¸‰å’Œç‹äº”å…³è”å…³ç³»çš„ä¸“é¡¹è°ƒæŸ¥</li>
                        <li>æš‚åœæŸæŸç§‘æŠ€å…¬å¸å‚ä¸æ–°é¡¹ç›®æŠ•æ ‡èµ„æ ¼</li>
                        <li>å¯¹å·²ç­¾è®¢åˆåŒè¿›è¡Œåˆè§„æ€§å®¡æŸ¥</li>
                        <li>å®Œå–„é‡‡è´­äººå‘˜å›é¿åˆ¶åº¦å’Œå…³è”å…³ç³»ç”³æŠ¥æœºåˆ¶</li>
                        <li>å»ºç«‹ä¾›åº”å•†å¼‚å¸¸è¡Œä¸ºç›‘æ§é¢„è­¦ç³»ç»Ÿ</li>
                    </ol>
                </div>
            `;
            
            document.getElementById('analysisContent').innerHTML = html;
        }
        
        // æ˜¾ç¤ºåˆ†æç»“æœ
        function showAnalysis() {
            if (!currentGraph) {
                alert('è¯·å…ˆæ„å»ºå›¾è°±');
                return;
            }
            switchTab('analysis');
        }
        
        // åˆ‡æ¢æ ‡ç­¾é¡µ
        function switchTab(tabName) {
            // ç§»é™¤æ‰€æœ‰activeç±»
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // æ·»åŠ activeç±»åˆ°å½“å‰æ ‡ç­¾
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }
        
        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
        function showSuccess(message) {
            const div = document.createElement('div');
            div.className = 'success-box';
            div.style.position = 'fixed';
            div.style.top = '20px';
            div.style.right = '20px';
            div.style.zIndex = '9999';
            div.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
            div.innerHTML = `<strong>âœ“ ${message}</strong>`;
            document.body.appendChild(div);
            
            setTimeout(() => {
                div.remove();
            }, 3000);
        }
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
